# 微信公众号生产环境部署指南\n\n## 概述\n\n本指南详细说明如何在生产环境中配置和部署微信公众号智能助手功能。\n\n## 前置条件\n\n- [x] 已注册并认证的微信公众号\n- [x] 服务器具有公网访问能力\n- [x] 已安装Node.js和MongoDB\n- [x] SSL证书配置完成（微信要求HTTPS）\n\n## 配置步骤\n\n### 1. 获取微信公众号凭据\n\n#### 1.1 登录微信公众平台\n访问 [微信公众平台](https://mp.weixin.qq.com/) 并登录您的公众号管理后台。\n\n#### 1.2 获取基本配置信息\n1. 进入「开发」→「基本配置」\n2. 获取以下信息：\n   - **AppID**: 公众号的唯一标识\n   - **AppSecret**: 公众号的应用密钥（如没有需要重新生成）\n\n#### 1.3 设置服务器配置\n1. 在「基本配置」页面找到「服务器配置」\n2. 点击「修改配置」\n3. 填写以下信息：\n   - **URL**: `https://yourdomain.com/api/wechat/webhook`\n   - **Token**: 自定义验证Token（记录下来，后续配置需要）\n   - **EncodingAESKey**: 消息加解密密钥（选择安全模式时需要）\n   - **消息加解密方式**: 建议选择「安全模式」\n\n### 2. 服务器环境配置\n\n#### 2.1 创建环境配置文件\n```bash\n# 复制配置模板\ncp server/.env.production.example server/.env.production\n\n# 编辑配置文件\nvim server/.env.production\n```\n\n#### 2.2 填写必要配置\n```bash\n# 基础配置\nNODE_ENV=production\nBASE_URL=https://yourdomain.com\n\n# 微信公众号配置\nWECHAT_APPID=wx1234567890abcdef\nWECHAT_APPSECRET=your-32-character-app-secret\nWECHAT_TOKEN=your-random-token-20-chars-plus\nWECHAT_ENCODING_AES_KEY=your-43-character-aes-key\n\n# 安全密钥\nJWT_SECRET=your-super-secure-jwt-secret-change-in-production\nWECHAT_CONFIG_KEY=your-config-encryption-key\n```\n\n#### 2.3 设置文件权限\n```bash\n# 设置配置文件为仅所有者可读\nchmod 600 server/.env.production\n\n# 确保应用可以创建必要目录\nmkdir -p server/data\nmkdir -p server/uploads\nchown -R appuser:appuser server/data server/uploads\n```\n\n### 3. 验证配置\n\n#### 3.1 运行配置检查\n```bash\n# 检查所有配置项\ncd server\nnode scripts/wechat-production-check.js\n```\n\n#### 3.2 测试微信API连接\n```bash\n# 使用配置管理API测试\ncurl -X POST https://yourdomain.com/api/wechat-config/test \\\n  -H \"Authorization: Bearer YOUR_ADMIN_TOKEN\" \\\n  -H \"Content-Type: application/json\"\n```\n\n#### 3.3 验证Webhook URL\n1. 在微信公众平台点击「提交」保存服务器配置\n2. 微信会发送GET请求验证URL有效性\n3. 查看服务器日志确认验证成功\n\n### 4. 创建自定义菜单\n\n#### 4.1 使用默认菜单配置\n```bash\n# 创建默认菜单\ncurl -X POST https://yourdomain.com/api/wechat-admin/create-menu \\\n  -H \"Authorization: Bearer YOUR_ADMIN_TOKEN\" \\\n  -H \"Content-Type: application/json\"\n```\n\n#### 4.2 自定义菜单配置\n1. 登录管理界面\n2. 进入「微信配置管理」\n3. 修改菜单配置\n4. 点击「保存并创建菜单」\n\n### 5. 生产环境优化\n\n#### 5.1 启用进程管理\n```bash\n# 使用PM2管理Node.js进程\nnpm install -g pm2\n\n# 创建PM2配置文件\ncat > ecosystem.config.js << EOF\nmodule.exports = {\n  apps: [{\n    name: 'intelligent-work-assistant',\n    script: './server/index.js',\n    env: {\n      NODE_ENV: 'development'\n    },\n    env_production: {\n      NODE_ENV: 'production'\n    },\n    instances: 2,\n    exec_mode: 'cluster',\n    max_memory_restart: '1G',\n    error_file: './logs/err.log',\n    out_file: './logs/out.log',\n    log_file: './logs/combined.log',\n    time: true\n  }]\n};\nEOF\n\n# 启动应用\npm2 start ecosystem.config.js --env production\n```\n\n#### 5.2 配置Nginx反向代理\n```nginx\nserver {\n    listen 80;\n    server_name yourdomain.com;\n    return 301 https://$server_name$request_uri;\n}\n\nserver {\n    listen 443 ssl http2;\n    server_name yourdomain.com;\n    \n    ssl_certificate /path/to/ssl/certificate.pem;\n    ssl_certificate_key /path/to/ssl/private.key;\n    \n    location /api/wechat/webhook {\n        proxy_pass http://localhost:5000;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection 'upgrade';\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_cache_bypass $http_upgrade;\n        \n        # 微信请求超时设置\n        proxy_connect_timeout 5s;\n        proxy_send_timeout 5s;\n        proxy_read_timeout 5s;\n    }\n    \n    location /api/ {\n        proxy_pass http://localhost:5000;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection 'upgrade';\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_cache_bypass $http_upgrade;\n    }\n    \n    location / {\n        proxy_pass http://localhost:3000;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection 'upgrade';\n        proxy_set_header Host $host;\n        proxy_cache_bypass $http_upgrade;\n    }\n}\n```\n\n#### 5.3 设置日志轮转\n```bash\n# 创建logrotate配置\ncat > /etc/logrotate.d/intelligent-work-assistant << EOF\n/path/to/app/logs/*.log {\n    daily\n    missingok\n    rotate 30\n    compress\n    delaycompress\n    notifempty\n    create 644 appuser appuser\n    postrotate\n        pm2 reload intelligent-work-assistant\n    endscript\n}\nEOF\n```\n\n### 6. 监控和维护\n\n#### 6.1 健康检查\n```bash\n# 创建健康检查脚本\ncat > scripts/health-check.sh << 'EOF'\n#!/bin/bash\n\n# 检查应用状态\nif curl -f http://localhost:5000/health > /dev/null 2>&1; then\n    echo \"[$(date)] Application is healthy\"\nelse\n    echo \"[$(date)] Application is down, restarting...\"\n    pm2 restart intelligent-work-assistant\nfi\n\n# 检查微信配置\nif node scripts/wechat-production-check.js > /dev/null 2>&1; then\n    echo \"[$(date)] WeChat configuration is valid\"\nelse\n    echo \"[$(date)] WeChat configuration issues detected\"\nfi\nEOF\n\nchmod +x scripts/health-check.sh\n\n# 添加到crontab\n(crontab -l 2>/dev/null; echo \"*/5 * * * * /path/to/app/scripts/health-check.sh >> /var/log/app-health.log\") | crontab -\n```\n\n#### 6.2 备份配置\n```bash\n# 创建配置备份脚本\ncat > scripts/backup-config.sh << 'EOF'\n#!/bin/bash\n\nBACKUP_DIR=\"/backup/wechat-config\"\nDATE=$(date +%Y%m%d-%H%M%S)\n\n# 创建备份目录\nmkdir -p $BACKUP_DIR\n\n# 备份配置文件\ncp server/.env.production $BACKUP_DIR/env-$DATE\ncp -r server/data $BACKUP_DIR/data-$DATE\n\n# 压缩备份\ntar -czf $BACKUP_DIR/config-backup-$DATE.tar.gz -C $BACKUP_DIR env-$DATE data-$DATE\n\n# 清理临时文件\nrm -rf $BACKUP_DIR/env-$DATE $BACKUP_DIR/data-$DATE\n\n# 保留最近7天的备份\nfind $BACKUP_DIR -name \"config-backup-*.tar.gz\" -mtime +7 -delete\n\necho \"Configuration backup completed: $BACKUP_DIR/config-backup-$DATE.tar.gz\"\nEOF\n\nchmod +x scripts/backup-config.sh\n\n# 每日备份\n(crontab -l 2>/dev/null; echo \"0 2 * * * /path/to/app/scripts/backup-config.sh\") | crontab -\n```\n\n### 7. 常见问题排查\n\n#### 7.1 URL验证失败\n```bash\n# 检查服务器是否可访问\ncurl -I https://yourdomain.com/api/wechat/webhook\n\n# 检查SSL证书\nopenssl s_client -connect yourdomain.com:443 -servername yourdomain.com\n\n# 查看应用日志\npm2 logs intelligent-work-assistant\n```\n\n#### 7.2 消息接收失败\n```bash\n# 检查微信Token配置\ngrep WECHAT_TOKEN server/.env.production\n\n# 验证签名算法\nnode -e \"console.log(require('./server/config/wechat-production').generateSignature('timestamp', 'nonce'))\"\n\n# 查看错误日志\ntail -f logs/err.log\n```\n\n#### 7.3 菜单创建失败\n```bash\n# 测试Access Token获取\ncurl \"https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=YOUR_APPID&secret=YOUR_APPSECRET\"\n\n# 检查菜单配置格式\nnode -e \"console.log(JSON.stringify(require('./server/config/wechat-production').getDefaultMenuConfig(), null, 2))\"\n```\n\n### 8. 安全最佳实践\n\n#### 8.1 访问控制\n- 使用强密码和复杂Token\n- 定期轮换密钥\n- 限制API访问IP\n- 启用HTTPS\n\n#### 8.2 数据保护\n- 加密存储敏感配置\n- 定期备份数据\n- 监控异常访问\n- 遵守数据保护法规\n\n#### 8.3 网络安全\n- 配置防火墙规则\n- 使用CDN和DDoS保护\n- 定期安全扫描\n- 及时更新依赖\n\n## 部署清单\n\n- [ ] 微信公众号凭据已获取\n- [ ] 服务器配置已完成\n- [ ] 环境变量已设置\n- [ ] SSL证书已配置\n- [ ] URL验证已通过\n- [ ] 菜单已创建\n- [ ] 进程管理已启用\n- [ ] 监控已配置\n- [ ] 备份策略已实施\n- [ ] 安全措施已加固\n\n## 联系支持\n\n如果在部署过程中遇到问题，请：\n\n1. 检查本文档的故障排查部分\n2. 运行配置检查脚本\n3. 查看应用日志文件\n4. 参考微信公众平台开发文档\n\n---\n\n**注意**: 生产环境部署涉及安全敏感信息，请确保遵循您组织的安全政策和最佳实践。