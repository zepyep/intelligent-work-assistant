#!/bin/bash\n\n# æ™ºèƒ½å·¥ä½œåŠ©æ‰‹ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è„šæœ¬\n# ç‰ˆæœ¬: 1.0.0\n# ä½œè€…: Intelligent Work Assistant Team\n\nset -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º\nset -u  # ä½¿ç”¨æœªå®šä¹‰å˜é‡æ—¶æŠ¥é”™\nset -o pipefail  # ç®¡é“ä¸­ä»»ä½•å‘½ä»¤å¤±è´¥éƒ½ä¼šå¯¼è‡´æ•´ä¸ªç®¡é“å¤±è´¥\n\n# é…ç½®å˜é‡\nSCRIPT_DIR=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\"\nPROJECT_ROOT=\"$(dirname \"$SCRIPT_DIR\")\"\nDEPLOY_DATE=$(date +\"%Y%m%d-%H%M%S\")\nBACKUP_DIR=\"/opt/iwa/backups\"\nDATA_DIR=\"/opt/iwa/data\"\nLOGS_DIR=\"/opt/iwa/logs\"\nENV_FILE=\".env.production\"\nDOCKER_COMPOSE_FILE=\"docker-compose.production.yml\"\n\n# é¢œè‰²è¾“å‡º\nRED='\\033[0;31m'\nGREEN='\\033[0;32m'\nYELLOW='\\033[1;33m'\nBLUE='\\033[0;34m'\nNC='\\033[0m' # No Color\n\n# æ—¥å¿—å‡½æ•°\nlog_info() {\n    echo -e \"${BLUE}[INFO]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1\"\n}\n\nlog_success() {\n    echo -e \"${GREEN}[SUCCESS]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1\"\n}\n\nlog_warning() {\n    echo -e \"${YELLOW}[WARNING]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1\"\n}\n\nlog_error() {\n    echo -e \"${RED}[ERROR]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1\"\n}\n\n# é”™è¯¯å¤„ç†\nhandle_error() {\n    log_error \"éƒ¨ç½²è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œåœ¨ç¬¬ $1 è¡Œ\"\n    log_error \"æ­£åœ¨æ‰§è¡Œå›æ»šæ“ä½œ...\"\n    rollback_deployment\n    exit 1\n}\n\ntrap 'handle_error $LINENO' ERR\n\n# æ£€æŸ¥ä¾èµ–\ncheck_dependencies() {\n    log_info \"æ£€æŸ¥ç³»ç»Ÿä¾èµ–...\"\n    \n    local deps=(\"docker\" \"docker-compose\" \"curl\" \"jq\" \"nginx\")\n    local missing_deps=()\n    \n    for dep in \"${deps[@]}\"; do\n        if ! command -v \"$dep\" &> /dev/null; then\n            missing_deps+=(\"$dep\")\n        fi\n    done\n    \n    if [ ${#missing_deps[@]} -ne 0 ]; then\n        log_error \"ç¼ºå°‘ä»¥ä¸‹ä¾èµ–: ${missing_deps[*]}\"\n        log_info \"è¯·å…ˆå®‰è£…å¿…è¦ä¾èµ–åå†æ‰§è¡Œéƒ¨ç½²\"\n        exit 1\n    fi\n    \n    log_success \"æ‰€æœ‰ä¾èµ–æ£€æŸ¥é€šè¿‡\"\n}\n\n# æ£€æŸ¥ç¯å¢ƒé…ç½®\ncheck_environment() {\n    log_info \"æ£€æŸ¥ç¯å¢ƒé…ç½®...\"\n    \n    cd \"$PROJECT_ROOT\"\n    \n    # æ£€æŸ¥é…ç½®æ–‡ä»¶\n    if [ ! -f \"server/$ENV_FILE\" ]; then\n        log_error \"ç¯å¢ƒé…ç½®æ–‡ä»¶ server/$ENV_FILE ä¸å­˜åœ¨\"\n        log_info \"è¯·å¤åˆ¶ server/.env.production.example å¹¶é…ç½®ç›¸åº”å‚æ•°\"\n        exit 1\n    fi\n    \n    # æ£€æŸ¥Docker Composeæ–‡ä»¶\n    if [ ! -f \"$DOCKER_COMPOSE_FILE\" ]; then\n        log_error \"Docker Composeé…ç½®æ–‡ä»¶ $DOCKER_COMPOSE_FILE ä¸å­˜åœ¨\"\n        exit 1\n    fi\n    \n    # éªŒè¯ç¯å¢ƒå˜é‡\n    source \"server/$ENV_FILE\"\n    \n    local required_vars=(\"MONGO_ROOT_PASSWORD\" \"REDIS_PASSWORD\" \"JWT_SECRET\" \n                        \"WECHAT_APPID\" \"WECHAT_APPSECRET\" \"WECHAT_TOKEN\")\n    local missing_vars=()\n    \n    for var in \"${required_vars[@]}\"; do\n        if [ -z \"${!var:-}\" ]; then\n            missing_vars+=(\"$var\")\n        fi\n    done\n    \n    if [ ${#missing_vars[@]} -ne 0 ]; then\n        log_error \"ä»¥ä¸‹ç¯å¢ƒå˜é‡æœªè®¾ç½®: ${missing_vars[*]}\"\n        exit 1\n    fi\n    \n    log_success \"ç¯å¢ƒé…ç½®æ£€æŸ¥é€šè¿‡\"\n}\n\n# åˆ›å»ºå¿…è¦ç›®å½•\ncreate_directories() {\n    log_info \"åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„...\"\n    \n    local dirs=(\"$BACKUP_DIR\" \"$DATA_DIR/mongodb\" \"$DATA_DIR/redis\" \n                \"$DATA_DIR/uploads\" \"$DATA_DIR/app\" \"$DATA_DIR/prometheus\" \n                \"$DATA_DIR/grafana\" \"$DATA_DIR/loki\" \"$LOGS_DIR\" \n                \"$LOGS_DIR/nginx\")\n    \n    for dir in \"${dirs[@]}\"; do\n        if [ ! -d \"$dir\" ]; then\n            sudo mkdir -p \"$dir\"\n            log_info \"åˆ›å»ºç›®å½•: $dir\"\n        fi\n    done\n    \n    # è®¾ç½®æ­£ç¡®çš„æƒé™\n    sudo chown -R $(whoami):$(whoami) \"$DATA_DIR\" \"$LOGS_DIR\" \"$BACKUP_DIR\"\n    \n    log_success \"ç›®å½•ç»“æ„åˆ›å»ºå®Œæˆ\"\n}\n\n# å¤‡ä»½ç°æœ‰æ•°æ®\nbackup_existing_data() {\n    log_info \"å¤‡ä»½ç°æœ‰æ•°æ®...\"\n    \n    local backup_path=\"$BACKUP_DIR/pre-deploy-$DEPLOY_DATE\"\n    mkdir -p \"$backup_path\"\n    \n    # å¤‡ä»½æ•°æ®åº“ï¼ˆå¦‚æœå­˜åœ¨ï¼‰\n    if docker ps | grep -q \"iwa-mongodb-prod\"; then\n        log_info \"å¤‡ä»½MongoDBæ•°æ®...\"\n        docker exec iwa-mongodb-prod mongodump --out /tmp/backup\n        docker cp iwa-mongodb-prod:/tmp/backup \"$backup_path/mongodb\"\n    fi\n    \n    # å¤‡ä»½ä¸Šä¼ æ–‡ä»¶\n    if [ -d \"$DATA_DIR/uploads\" ] && [ \"$(ls -A $DATA_DIR/uploads)\" ]; then\n        log_info \"å¤‡ä»½ä¸Šä¼ æ–‡ä»¶...\"\n        cp -r \"$DATA_DIR/uploads\" \"$backup_path/\"\n    fi\n    \n    # å¤‡ä»½åº”ç”¨æ•°æ®\n    if [ -d \"$DATA_DIR/app\" ] && [ \"$(ls -A $DATA_DIR/app)\" ]; then\n        log_info \"å¤‡ä»½åº”ç”¨æ•°æ®...\"\n        cp -r \"$DATA_DIR/app\" \"$backup_path/\"\n    fi\n    \n    # åˆ›å»ºå¤‡ä»½æ¸…å•\n    echo \"Backup created at: $(date)\" > \"$backup_path/backup_info.txt\"\n    echo \"Deploy date: $DEPLOY_DATE\" >> \"$backup_path/backup_info.txt\"\n    echo \"Project version: $(git rev-parse HEAD 2>/dev/null || echo 'unknown')\" >> \"$backup_path/backup_info.txt\"\n    \n    log_success \"æ•°æ®å¤‡ä»½å®Œæˆ: $backup_path\"\n}\n\n# åœæ­¢ç°æœ‰æœåŠ¡\nstop_existing_services() {\n    log_info \"åœæ­¢ç°æœ‰æœåŠ¡...\"\n    \n    cd \"$PROJECT_ROOT\"\n    \n    # ä¼˜é›…åœæ­¢Docker ComposeæœåŠ¡\n    if [ -f \"$DOCKER_COMPOSE_FILE\" ]; then\n        docker-compose -f \"$DOCKER_COMPOSE_FILE\" down --timeout 30 || true\n    fi\n    \n    # ç¡®ä¿æ‰€æœ‰ç›¸å…³å®¹å™¨éƒ½å·²åœæ­¢\n    local containers=($(docker ps --filter \"name=iwa-\" --format \"{{.Names}}\" || true))\n    if [ ${#containers[@]} -gt 0 ]; then\n        log_info \"åœæ­¢æ®‹ç•™å®¹å™¨: ${containers[*]}\"\n        docker stop \"${containers[@]}\" || true\n        docker rm \"${containers[@]}\" || true\n    fi\n    \n    log_success \"ç°æœ‰æœåŠ¡å·²åœæ­¢\"\n}\n\n# æ„å»ºDockeré•œåƒ\nbuild_images() {\n    log_info \"æ„å»ºDockeré•œåƒ...\"\n    \n    cd \"$PROJECT_ROOT\"\n    \n    # æ‹‰å–åŸºç¡€é•œåƒæ›´æ–°\n    docker-compose -f \"$DOCKER_COMPOSE_FILE\" pull --quiet\n    \n    # æ„å»ºè‡ªå®šä¹‰é•œåƒ\n    docker-compose -f \"$DOCKER_COMPOSE_FILE\" build --no-cache\n    \n    log_success \"Dockeré•œåƒæ„å»ºå®Œæˆ\"\n}\n\n# å¯åŠ¨æœåŠ¡\nstart_services() {\n    log_info \"å¯åŠ¨æœåŠ¡...\"\n    \n    cd \"$PROJECT_ROOT\"\n    \n    # å¯åŠ¨æœåŠ¡\n    docker-compose -f \"$DOCKER_COMPOSE_FILE\" up -d\n    \n    log_info \"ç­‰å¾…æœåŠ¡å¯åŠ¨...\"\n    sleep 30\n    \n    # æ£€æŸ¥æœåŠ¡çŠ¶æ€\n    local services=(\"mongodb\" \"redis\" \"backend\" \"frontend\" \"nginx\")\n    for service in \"${services[@]}\"; do\n        if docker-compose -f \"$DOCKER_COMPOSE_FILE\" ps | grep -q \"iwa-${service}-prod.*Up\"; then\n            log_success \"$service æœåŠ¡å¯åŠ¨æˆåŠŸ\"\n        else\n            log_error \"$service æœåŠ¡å¯åŠ¨å¤±è´¥\"\n            docker-compose -f \"$DOCKER_COMPOSE_FILE\" logs \"$service\"\n            exit 1\n        fi\n    done\n    \n    log_success \"æ‰€æœ‰æœåŠ¡å¯åŠ¨å®Œæˆ\"\n}\n\n# å¥åº·æ£€æŸ¥\nhealth_check() {\n    log_info \"æ‰§è¡Œå¥åº·æ£€æŸ¥...\"\n    \n    local max_attempts=30\n    local attempt=1\n    \n    # æ£€æŸ¥åç«¯å¥åº·çŠ¶æ€\n    while [ $attempt -le $max_attempts ]; do\n        if curl -f http://localhost:5000/health > /dev/null 2>&1; then\n            log_success \"åç«¯æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡\"\n            break\n        fi\n        \n        if [ $attempt -eq $max_attempts ]; then\n            log_error \"åç«¯æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥\"\n            docker-compose -f \"$DOCKER_COMPOSE_FILE\" logs backend\n            exit 1\n        fi\n        \n        log_info \"ç­‰å¾…åç«¯æœåŠ¡å¯åŠ¨... ($attempt/$max_attempts)\"\n        sleep 5\n        ((attempt++))\n    done\n    \n    # æ£€æŸ¥å‰ç«¯æœåŠ¡\n    if curl -f http://localhost:3000 > /dev/null 2>&1; then\n        log_success \"å‰ç«¯æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡\"\n    else\n        log_error \"å‰ç«¯æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥\"\n        docker-compose -f \"$DOCKER_COMPOSE_FILE\" logs frontend\n        exit 1\n    fi\n    \n    # æ£€æŸ¥Nginx\n    if curl -f http://localhost:80/health > /dev/null 2>&1; then\n        log_success \"NginxæœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡\"\n    else\n        log_error \"NginxæœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥\"\n        docker-compose -f \"$DOCKER_COMPOSE_FILE\" logs nginx\n        exit 1\n    fi\n}\n\n# è¿è¡Œå¾®ä¿¡é…ç½®æ£€æŸ¥\nrun_wechat_check() {\n    log_info \"è¿è¡Œå¾®ä¿¡é…ç½®æ£€æŸ¥...\"\n    \n    # åœ¨å®¹å™¨ä¸­è¿è¡Œæ£€æŸ¥è„šæœ¬\n    if docker exec iwa-backend-prod node scripts/wechat-production-check.js; then\n        log_success \"å¾®ä¿¡é…ç½®æ£€æŸ¥é€šè¿‡\"\n    else\n        log_warning \"å¾®ä¿¡é…ç½®æ£€æŸ¥æœªé€šè¿‡ï¼Œè¯·æ£€æŸ¥å¾®ä¿¡ç›¸å…³é…ç½®\"\n    fi\n}\n\n# æ¸…ç†æ—§é•œåƒå’Œå®¹å™¨\ncleanup_old_resources() {\n    log_info \"æ¸…ç†æ—§çš„Dockerèµ„æº...\"\n    \n    # æ¸…ç†æ— ç”¨é•œåƒ\n    docker image prune -f > /dev/null 2>&1 || true\n    \n    # æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘7å¤©ï¼‰\n    find \"$BACKUP_DIR\" -type d -name \"pre-deploy-*\" -mtime +7 -exec rm -rf {} + 2>/dev/null || true\n    \n    log_success \"èµ„æºæ¸…ç†å®Œæˆ\"\n}\n\n# æ›´æ–°ç³»ç»ŸæœåŠ¡ï¼ˆå¦‚systemdï¼‰\nupdate_system_services() {\n    log_info \"æ›´æ–°ç³»ç»ŸæœåŠ¡é…ç½®...\"\n    \n    # åˆ›å»ºsystemdæœåŠ¡æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰\n    local service_file=\"/etc/systemd/system/intelligent-work-assistant.service\"\n    if [ ! -f \"$service_file\" ]; then\n        sudo tee \"$service_file\" > /dev/null <<EOF\n[Unit]\nDescription=Intelligent Work Assistant\nRequires=docker.service\nAfter=docker.service\n\n[Service]\nType=oneshot\nRemainAfterExit=yes\nWorkingDirectory=$PROJECT_ROOT\nExecStart=/usr/bin/docker-compose -f $DOCKER_COMPOSE_FILE up -d\nExecStop=/usr/bin/docker-compose -f $DOCKER_COMPOSE_FILE down\nTimeoutStartSec=0\n\n[Install]\nWantedBy=multi-user.target\nEOF\n        \n        sudo systemctl daemon-reload\n        sudo systemctl enable intelligent-work-assistant.service\n        log_success \"ç³»ç»ŸæœåŠ¡é…ç½®å®Œæˆ\"\n    fi\n}\n\n# å‘é€éƒ¨ç½²é€šçŸ¥\nsend_notification() {\n    log_info \"å‘é€éƒ¨ç½²å®Œæˆé€šçŸ¥...\"\n    \n    local webhook_url=\"${DEPLOY_WEBHOOK_URL:-}\"\n    if [ -n \"$webhook_url\" ]; then\n        curl -X POST \"$webhook_url\" \\\n            -H \"Content-Type: application/json\" \\\n            -d \"{\n                \\\"text\\\": \\\"ğŸš€ æ™ºèƒ½å·¥ä½œåŠ©æ‰‹éƒ¨ç½²å®Œæˆ\\\\næ—¶é—´: $(date)\\\\nç‰ˆæœ¬: $(git rev-parse --short HEAD 2>/dev/null || echo 'unknown')\\\\nçŠ¶æ€: æˆåŠŸ\\\"\n            }\" > /dev/null 2>&1 || true\n    fi\n}\n\n# å›æ»šéƒ¨ç½²\nrollback_deployment() {\n    log_warning \"å¼€å§‹å›æ»šéƒ¨ç½²...\"\n    \n    # åœæ­¢å½“å‰æœåŠ¡\n    docker-compose -f \"$DOCKER_COMPOSE_FILE\" down --timeout 30 || true\n    \n    # æ¢å¤æœ€æ–°å¤‡ä»½ï¼ˆå¦‚æœå­˜åœ¨ï¼‰\n    local latest_backup=$(find \"$BACKUP_DIR\" -type d -name \"pre-deploy-*\" | sort -r | head -n1)\n    if [ -n \"$latest_backup\" ] && [ -d \"$latest_backup\" ]; then\n        log_info \"æ¢å¤å¤‡ä»½: $latest_backup\"\n        \n        # æ¢å¤æ•°æ®æ–‡ä»¶\n        if [ -d \"$latest_backup/uploads\" ]; then\n            rm -rf \"$DATA_DIR/uploads\"\n            cp -r \"$latest_backup/uploads\" \"$DATA_DIR/\"\n        fi\n        \n        if [ -d \"$latest_backup/app\" ]; then\n            rm -rf \"$DATA_DIR/app\"\n            cp -r \"$latest_backup/app\" \"$DATA_DIR/\"\n        fi\n        \n        log_success \"æ•°æ®å›æ»šå®Œæˆ\"\n    fi\n}\n\n# æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯\nshow_deployment_info() {\n    log_success \"ğŸ‰ éƒ¨ç½²å®Œæˆï¼\"\n    echo\n    echo \"=== éƒ¨ç½²ä¿¡æ¯ ===\"\n    echo \"éƒ¨ç½²æ—¶é—´: $DEPLOY_DATE\"\n    echo \"é¡¹ç›®ç‰ˆæœ¬: $(git rev-parse --short HEAD 2>/dev/null || echo 'unknown')\"\n    echo \"æœåŠ¡çŠ¶æ€:\"\n    docker-compose -f \"$DOCKER_COMPOSE_FILE\" ps\n    echo\n    echo \"=== è®¿é—®åœ°å€ ===\"\n    echo \"åº”ç”¨åœ°å€: http://localhost (ç”Ÿäº§ç¯å¢ƒè¯·é…ç½®åŸŸåå’ŒSSL)\"\n    echo \"APIæ–‡æ¡£: http://localhost/api-docs\"\n    echo \"ç›‘æ§é¢æ¿: http://localhost:3001 (Grafana)\"\n    echo \"æŒ‡æ ‡æ”¶é›†: http://localhost:9090 (Prometheus)\"\n    echo\n    echo \"=== ç®¡ç†å‘½ä»¤ ===\"\n    echo \"æŸ¥çœ‹æ—¥å¿—: docker-compose -f $DOCKER_COMPOSE_FILE logs -f [æœåŠ¡å]\"\n    echo \"é‡å¯æœåŠ¡: docker-compose -f $DOCKER_COMPOSE_FILE restart [æœåŠ¡å]\"\n    echo \"åœæ­¢æœåŠ¡: docker-compose -f $DOCKER_COMPOSE_FILE down\"\n    echo\n    echo \"=== é‡è¦æé†’ ===\"\n    echo \"1. è¯·åŠæ—¶é…ç½®SSLè¯ä¹¦å’ŒåŸŸå\"\n    echo \"2. ä¿®æ”¹é»˜è®¤å¯†ç ï¼ˆæ•°æ®åº“ã€Grafanaç­‰ï¼‰\"\n    echo \"3. é…ç½®ç”Ÿäº§ç¯å¢ƒçš„å¤‡ä»½ç­–ç•¥\"\n    echo \"4. è®¾ç½®ç›‘æ§å‘Šè­¦è§„åˆ™\"\n    echo\n}\n\n# ä¸»è¦éƒ¨ç½²æµç¨‹\nmain() {\n    log_info \"å¼€å§‹æ™ºèƒ½å·¥ä½œåŠ©æ‰‹ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²...\"\n    log_info \"éƒ¨ç½²æ—¶é—´: $DEPLOY_DATE\"\n    \n    check_dependencies\n    check_environment\n    create_directories\n    backup_existing_data\n    stop_existing_services\n    build_images\n    start_services\n    health_check\n    run_wechat_check\n    cleanup_old_resources\n    update_system_services\n    send_notification\n    show_deployment_info\n    \n    log_success \"ğŸ‰ æ™ºèƒ½å·¥ä½œåŠ©æ‰‹éƒ¨ç½²æˆåŠŸå®Œæˆï¼\"\n}\n\n# å‚æ•°å¤„ç†\nwhile [[ $# -gt 0 ]]; do\n    case $1 in\n        --skip-backup)\n            SKIP_BACKUP=true\n            shift\n            ;;\n        --skip-health-check)\n            SKIP_HEALTH_CHECK=true\n            shift\n            ;;\n        --rollback)\n            rollback_deployment\n            exit 0\n            ;;\n        -h|--help)\n            echo \"ç”¨æ³•: $0 [é€‰é¡¹]\"\n            echo \"é€‰é¡¹:\"\n            echo \"  --skip-backup       è·³è¿‡å¤‡ä»½æ­¥éª¤\"\n            echo \"  --skip-health-check è·³è¿‡å¥åº·æ£€æŸ¥\"\n            echo \"  --rollback          å›æ»šåˆ°ä¸Šä¸€ä¸ªå¤‡ä»½\"\n            echo \"  -h, --help          æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯\"\n            exit 0\n            ;;\n        *)\n            log_error \"æœªçŸ¥å‚æ•°: $1\"\n            exit 1\n            ;;\n    esac\ndone\n\n# æ‰§è¡Œä¸»æµç¨‹\nmain