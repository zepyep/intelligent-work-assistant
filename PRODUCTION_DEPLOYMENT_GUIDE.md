# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—\n\næ™ºèƒ½å·¥ä½œåŠ©æ‰‹åº”ç”¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæ•´æŒ‡å—ã€‚\n\n## ğŸ“‹ ç›®å½•\n\n- [æ¦‚è¿°](#æ¦‚è¿°)\n- [ç³»ç»Ÿè¦æ±‚](#ç³»ç»Ÿè¦æ±‚)\n- [éƒ¨ç½²å‰å‡†å¤‡](#éƒ¨ç½²å‰å‡†å¤‡)\n- [å¿«é€Ÿéƒ¨ç½²](#å¿«é€Ÿéƒ¨ç½²)\n- [è¯¦ç»†é…ç½®](#è¯¦ç»†é…ç½®)\n- [ç›‘æ§å’Œç»´æŠ¤](#ç›‘æ§å’Œç»´æŠ¤)\n- [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)\n- [å®‰å…¨åŠ å›º](#å®‰å…¨åŠ å›º)\n\n## ğŸ¯ æ¦‚è¿°\n\næœ¬æŒ‡å—æä¾›äº†æ™ºèƒ½å·¥ä½œåŠ©æ‰‹åº”ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„å®Œæ•´éƒ¨ç½²æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š\n\n- **å®¹å™¨åŒ–éƒ¨ç½²**: ä½¿ç”¨Dockerå’ŒDocker Compose\n- **æœåŠ¡ç¼–æ’**: MongoDBã€Redisã€Node.jsåç«¯ã€Reactå‰ç«¯ã€Nginxåå‘ä»£ç†\n- **ç›‘æ§ä½“ç³»**: Prometheus + Grafana + Lokiæ—¥å¿—èšåˆ\n- **è‡ªåŠ¨åŒ–éƒ¨ç½²**: ä¸€é”®éƒ¨ç½²è„šæœ¬å’ŒCI/CDé›†æˆ\n- **å®‰å…¨é˜²æŠ¤**: SSLã€é˜²ç«å¢™ã€è®¿é—®æ§åˆ¶\n\n## ğŸ’» ç³»ç»Ÿè¦æ±‚\n\n### ç¡¬ä»¶è¦æ±‚\n\n| ç»„ä»¶ | æœ€ä½é…ç½® | æ¨èé…ç½® |\n|------|----------|----------|\n| CPU | 2æ ¸ | 4æ ¸+ |\n| å†…å­˜ | 4GB | 8GB+ |\n| å­˜å‚¨ | 50GB | 100GB+ SSD |\n| ç½‘ç»œ | 10Mbps | 100Mbps+ |\n\n### è½¯ä»¶è¦æ±‚\n\n- **æ“ä½œç³»ç»Ÿ**: Ubuntu 20.04+ / CentOS 8+ / Debian 11+\n- **Docker**: 20.10+\n- **Docker Compose**: 2.0+\n- **SSLè¯ä¹¦**: Let's Encryptæˆ–å•†ä¸šè¯ä¹¦\n- **åŸŸå**: å·²è§£æåˆ°æœåŠ¡å™¨IP\n\n### ç½‘ç»œè¦æ±‚\n\n- **å…¥ç«™ç«¯å£**: 80 (HTTP), 443 (HTTPS), 22 (SSH)\n- **å‡ºç«™ç«¯å£**: 80, 443 (è®¿é—®å¾®ä¿¡APIå’Œå…¶ä»–å¤–éƒ¨æœåŠ¡)\n\n## ğŸš€ éƒ¨ç½²å‰å‡†å¤‡\n\n### 1. æœåŠ¡å™¨åˆå§‹åŒ–\n\n```bash\n# æ›´æ–°ç³»ç»Ÿ\nsudo apt update && sudo apt upgrade -y\n\n# å®‰è£…å¿…è¦å·¥å…·\nsudo apt install -y curl wget git vim htop ufw fail2ban\n\n# é…ç½®é˜²ç«å¢™\nsudo ufw allow ssh\nsudo ufw allow http\nsudo ufw allow https\nsudo ufw --force enable\n```\n\n### 2. å®‰è£…Docker\n\n```bash\n# å®‰è£…Docker\ncurl -fsSL https://get.docker.com -o get-docker.sh\nsudo sh get-docker.sh\n\n# æ·»åŠ å½“å‰ç”¨æˆ·åˆ°dockerç»„\nsudo usermod -aG docker $USER\n\n# å®‰è£…Docker Compose\nsudo curl -L \"https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)\" -o /usr/local/bin/docker-compose\nsudo chmod +x /usr/local/bin/docker-compose\n\n# é‡å¯å¹¶æµ‹è¯•\nsudo systemctl enable docker\nsudo systemctl start docker\ndocker --version\ndocker-compose --version\n```\n\n### 3. åˆ›å»ºé¡¹ç›®ç›®å½•\n\n```bash\n# åˆ›å»ºé¡¹ç›®ç›®å½•\nsudo mkdir -p /opt/iwa\nsudo chown $USER:$USER /opt/iwa\ncd /opt/iwa\n\n# å…‹éš†é¡¹ç›®ä»£ç \ngit clone <your-repository-url> .\n```\n\n### 4. è·å–SSLè¯ä¹¦\n\n```bash\n# å®‰è£…Certbot\nsudo apt install -y certbot python3-certbot-nginx\n\n# è·å–è¯ä¹¦ï¼ˆæ›¿æ¢yourdomain.comä¸ºä½ çš„åŸŸåï¼‰\nsudo certbot certonly --standalone -d yourdomain.com -d www.yourdomain.com\n\n# å¤åˆ¶è¯ä¹¦åˆ°é¡¹ç›®ç›®å½•\nsudo mkdir -p /opt/iwa/nginx/ssl\nsudo cp /etc/letsencrypt/live/yourdomain.com/fullchain.pem /opt/iwa/nginx/ssl/\nsudo cp /etc/letsencrypt/live/yourdomain.com/privkey.pem /opt/iwa/nginx/ssl/\nsudo chown -R $USER:$USER /opt/iwa/nginx/ssl\n```\n\n## âš¡ å¿«é€Ÿéƒ¨ç½²\n\n### 1. é…ç½®ç¯å¢ƒå˜é‡\n\n```bash\ncd /opt/iwa\n\n# å¤åˆ¶ç¯å¢ƒé…ç½®æ¨¡æ¿\ncp server/.env.production.example server/.env.production\n\n# ç¼–è¾‘é…ç½®æ–‡ä»¶\nvim server/.env.production\n```\n\n**å¿…é¡»é…ç½®çš„å…³é”®å˜é‡**:\n\n```bash\n# åŸºç¡€é…ç½®\nBASE_URL=https://yourdomain.com\n\n# æ•°æ®åº“å¯†ç \nMONGO_ROOT_PASSWORD=your-secure-mongo-password\nREDIS_PASSWORD=your-secure-redis-password\n\n# å®‰å…¨å¯†é’¥ï¼ˆä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ç”Ÿæˆï¼‰\nJWT_SECRET=your-jwt-secret\nSESSION_SECRET=your-session-secret\nWECHAT_CONFIG_KEY=your-wechat-config-key\n\n# å¾®ä¿¡å…¬ä¼—å·é…ç½®\nWECHAT_APPID=your-wechat-app-id\nWECHAT_APPSECRET=your-wechat-app-secret\nWECHAT_TOKEN=your-wechat-token\nWECHAT_ENCODING_AES_KEY=your-encoding-aes-key\n\n# Grafanaç®¡ç†å‘˜å¯†ç \nGRAFANA_ADMIN_PASSWORD=your-grafana-password\n```\n\n**ç”Ÿæˆå®‰å…¨å¯†é’¥**:\n\n```bash\n# ç”Ÿæˆå¼ºéšæœºå¯†é’¥\nnode -e \"console.log('JWT_SECRET=' + require('crypto').randomBytes(64).toString('hex'))\"\nnode -e \"console.log('SESSION_SECRET=' + require('crypto').randomBytes(32).toString('hex'))\"\nnode -e \"console.log('WECHAT_CONFIG_KEY=' + require('crypto').randomBytes(32).toString('hex'))\"\n```\n\n### 2. è¿è¡Œéƒ¨ç½²è„šæœ¬\n\n```bash\n# è¿è¡Œè‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬\n./scripts/production-deploy.sh\n```\n\n### 3. éªŒè¯éƒ¨ç½²\n\n```bash\n# æ£€æŸ¥æœåŠ¡çŠ¶æ€\ndocker-compose -f docker-compose.production.yml ps\n\n# æŸ¥çœ‹æœåŠ¡æ—¥å¿—\ndocker-compose -f docker-compose.production.yml logs -f\n\n# æµ‹è¯•æœåŠ¡\ncurl http://localhost/health\ncurl https://yourdomain.com/api/health\n```\n\n## âš™ï¸ è¯¦ç»†é…ç½®\n\n### ç›‘æ§é…ç½®\n\n#### Prometheusé…ç½®\n\nåˆ›å»º `monitoring/prometheus.yml`:\n\n```yaml\nglobal:\n  scrape_interval: 15s\n  evaluation_interval: 15s\n\nrule_files:\n  - \"rules/*.yml\"\n\nscrape_configs:\n  - job_name: 'nodejs-app'\n    static_configs:\n      - targets: ['backend:5000']\n    metrics_path: '/metrics'\n    scrape_interval: 30s\n\n  - job_name: 'nginx'\n    static_configs:\n      - targets: ['nginx:80']\n    metrics_path: '/nginx_status'\n    scrape_interval: 30s\n\n  - job_name: 'mongodb'\n    static_configs:\n      - targets: ['mongodb:27017']\n\n  - job_name: 'redis'\n    static_configs:\n      - targets: ['redis:6379']\n```\n\n#### Grafanaä»ªè¡¨æ¿\n\nè®¿é—® `https://yourdomain.com:3001` é…ç½®Grafana:\n\n1. ä½¿ç”¨é…ç½®çš„ç®¡ç†å‘˜å¯†ç ç™»å½•\n2. æ·»åŠ Prometheusæ•°æ®æº: `http://prometheus:9090`\n3. å¯¼å…¥é¢„é…ç½®çš„ä»ªè¡¨æ¿\n4. é…ç½®å‘Šè­¦è§„åˆ™\n\n### å¤‡ä»½ç­–ç•¥\n\n#### è‡ªåŠ¨å¤‡ä»½é…ç½®\n\n```bash\n# åˆ›å»ºå¤‡ä»½è„šæœ¬\ncat > /opt/iwa/scripts/backup.sh << 'EOF'\n#!/bin/bash\n\nBACKUP_DIR=\"/opt/iwa/backups/$(date +%Y%m%d-%H%M%S)\"\nmkdir -p \"$BACKUP_DIR\"\n\n# å¤‡ä»½æ•°æ®åº“\ndocker exec iwa-mongodb-prod mongodump --out /tmp/backup\ndocker cp iwa-mongodb-prod:/tmp/backup \"$BACKUP_DIR/mongodb\"\n\n# å¤‡ä»½åº”ç”¨æ•°æ®\ncp -r /opt/iwa/data/uploads \"$BACKUP_DIR/\"\ncp -r /opt/iwa/data/app \"$BACKUP_DIR/\"\n\n# æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™7å¤©ï¼‰\nfind /opt/iwa/backups -type d -mtime +7 -exec rm -rf {} +\n\necho \"Backup completed: $BACKUP_DIR\"\nEOF\n\nchmod +x /opt/iwa/scripts/backup.sh\n\n# æ·»åŠ åˆ°crontab\n(crontab -l 2>/dev/null; echo \"0 2 * * * /opt/iwa/scripts/backup.sh\") | crontab -\n```\n\n### æ—¥å¿—ç®¡ç†\n\n#### é…ç½®æ—¥å¿—è½®è½¬\n\n```bash\n# åˆ›å»ºlogrotateé…ç½®\nsudo tee /etc/logrotate.d/intelligent-work-assistant << 'EOF'\n/opt/iwa/logs/*.log {\n    daily\n    missingok\n    rotate 30\n    compress\n    delaycompress\n    notifempty\n    create 644 root root\n    postrotate\n        docker-compose -f /opt/iwa/docker-compose.production.yml restart nginx\n    endscript\n}\nEOF\n```\n\n### SSLè¯ä¹¦è‡ªåŠ¨ç»­æœŸ\n\n```bash\n# åˆ›å»ºè¯ä¹¦ç»­æœŸè„šæœ¬\ncat > /opt/iwa/scripts/renew-ssl.sh << 'EOF'\n#!/bin/bash\n\n# ç»­æœŸè¯ä¹¦\nsudo certbot renew --quiet\n\n# æ›´æ–°é¡¹ç›®ä¸­çš„è¯ä¹¦\nif [ -f \"/etc/letsencrypt/live/yourdomain.com/fullchain.pem\" ]; then\n    sudo cp /etc/letsencrypt/live/yourdomain.com/fullchain.pem /opt/iwa/nginx/ssl/\n    sudo cp /etc/letsencrypt/live/yourdomain.com/privkey.pem /opt/iwa/nginx/ssl/\n    \n    # é‡å¯nginx\n    docker-compose -f /opt/iwa/docker-compose.production.yml restart nginx\n    \n    echo \"SSLè¯ä¹¦å·²æ›´æ–°\"\nfi\nEOF\n\nchmod +x /opt/iwa/scripts/renew-ssl.sh\n\n# æ·»åŠ åˆ°crontabï¼ˆæ¯æœˆæ£€æŸ¥ä¸€æ¬¡ï¼‰\n(crontab -l 2>/dev/null; echo \"0 3 1 * * /opt/iwa/scripts/renew-ssl.sh\") | crontab -\n```\n\n## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤\n\n### æœåŠ¡å¥åº·ç›‘æ§\n\n```bash\n# æ£€æŸ¥æ‰€æœ‰æœåŠ¡çŠ¶æ€\ndocker-compose -f docker-compose.production.yml ps\n\n# æŸ¥çœ‹æœåŠ¡èµ„æºä½¿ç”¨æƒ…å†µ\ndocker stats\n\n# æŸ¥çœ‹ç³»ç»Ÿèµ„æº\nhtop\ndf -h\nfree -m\n```\n\n### æ€§èƒ½ç›‘æ§æŒ‡æ ‡\n\n- **åº”ç”¨æŒ‡æ ‡**: å“åº”æ—¶é—´ã€è¯·æ±‚é‡ã€é”™è¯¯ç‡\n- **ç³»ç»ŸæŒ‡æ ‡**: CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œä½¿ç”¨ç‡\n- **ä¸šåŠ¡æŒ‡æ ‡**: ç”¨æˆ·æ´»è·ƒåº¦ã€ä»»åŠ¡å®Œæˆç‡ã€å¾®ä¿¡æ¶ˆæ¯å¤„ç†é‡\n\n### å‘Šè­¦é…ç½®\n\nåœ¨Grafanaä¸­é…ç½®ä»¥ä¸‹å‘Šè­¦è§„åˆ™ï¼š\n\n- CPUä½¿ç”¨ç‡ > 80%\n- å†…å­˜ä½¿ç”¨ç‡ > 85%\n- ç£ç›˜ä½¿ç”¨ç‡ > 90%\n- APIå“åº”æ—¶é—´ > 3ç§’\n- é”™è¯¯ç‡ > 5%\n\n## ğŸ”§ æ•…éšœæ’æŸ¥\n\n### å¸¸è§é—®é¢˜\n\n#### 1. æœåŠ¡æ— æ³•å¯åŠ¨\n\n```bash\n# æŸ¥çœ‹æœåŠ¡æ—¥å¿—\ndocker-compose -f docker-compose.production.yml logs [service-name]\n\n# æ£€æŸ¥é…ç½®æ–‡ä»¶\ndocker-compose -f docker-compose.production.yml config\n\n# é‡å¯ç‰¹å®šæœåŠ¡\ndocker-compose -f docker-compose.production.yml restart [service-name]\n```\n\n#### 2. æ•°æ®åº“è¿æ¥å¤±è´¥\n\n```bash\n# æ£€æŸ¥MongoDBçŠ¶æ€\ndocker exec iwa-mongodb-prod mongosh --eval \"db.adminCommand('ping')\"\n\n# æ£€æŸ¥RedisçŠ¶æ€\ndocker exec iwa-redis-prod redis-cli ping\n\n# æ£€æŸ¥ç½‘ç»œè¿æ¥\ndocker-compose -f docker-compose.production.yml exec backend ping mongodb\n```\n\n#### 3. å¾®ä¿¡æ¥å£é—®é¢˜\n\n```bash\n# è¿è¡Œå¾®ä¿¡é…ç½®æ£€æŸ¥\ndocker exec iwa-backend-prod node scripts/wechat-production-check.js\n\n# æŸ¥çœ‹å¾®ä¿¡ç›¸å…³æ—¥å¿—\ndocker-compose -f docker-compose.production.yml logs backend | grep -i wechat\n\n# æµ‹è¯•å¾®ä¿¡APIè¿æ¥\ncurl -X POST \"https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=YOUR_APPID&secret=YOUR_SECRET\"\n```\n\n#### 4. SSLè¯ä¹¦é—®é¢˜\n\n```bash\n# æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸ\nopenssl x509 -in /opt/iwa/nginx/ssl/fullchain.pem -text -noout | grep -A2 \"Validity\"\n\n# æµ‹è¯•HTTPSè¿æ¥\ncurl -I https://yourdomain.com\n\n# æ£€æŸ¥è¯ä¹¦é“¾\nopenssl s_client -connect yourdomain.com:443 -servername yourdomain.com\n```\n\n### ç´§æ€¥æ¢å¤\n\n#### æœåŠ¡å›æ»š\n\n```bash\n# ä½¿ç”¨éƒ¨ç½²è„šæœ¬å›æ»š\n./scripts/production-deploy.sh --rollback\n\n# æ‰‹åŠ¨å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬\ngit checkout HEAD~1\ndocker-compose -f docker-compose.production.yml down\ndocker-compose -f docker-compose.production.yml up -d\n```\n\n#### æ•°æ®æ¢å¤\n\n```bash\n# æŸ¥æ‰¾å¯ç”¨å¤‡ä»½\nls -la /opt/iwa/backups/\n\n# æ¢å¤æ•°æ®åº“\ndocker exec -i iwa-mongodb-prod mongorestore /backup/path\n\n# æ¢å¤æ–‡ä»¶\ncp -r /opt/iwa/backups/latest/uploads /opt/iwa/data/\n```\n\n## ğŸ”’ å®‰å…¨åŠ å›º\n\n### ç³»ç»Ÿå®‰å…¨\n\n```bash\n# é…ç½®fail2ban\nsudo systemctl enable fail2ban\nsudo systemctl start fail2ban\n\n# æ›´æ–°ç³»ç»Ÿ\nsudo apt update && sudo apt upgrade -y\n\n# é…ç½®è‡ªåŠ¨å®‰å…¨æ›´æ–°\nsudo apt install -y unattended-upgrades\nsudo dpkg-reconfigure unattended-upgrades\n```\n\n### åº”ç”¨å®‰å…¨\n\n```bash\n# å®šæœŸæ›´æ–°Dockeré•œåƒ\ndocker-compose -f docker-compose.production.yml pull\ndocker-compose -f docker-compose.production.yml up -d\n\n# æ‰«æå®‰å…¨æ¼æ´\ndocker run --rm -v /var/run/docker.sock:/var/run/docker.sock \\\n  -v \"$PWD:/tmp/clair-scanner-logs\" \\\n  aquasec/trivy image your-image-name\n```\n\n### ç½‘ç»œå®‰å…¨\n\n```bash\n# é…ç½®iptablesè§„åˆ™\nsudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT\nsudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT\nsudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT\nsudo iptables -A INPUT -j DROP\n\n# ä¿å­˜iptablesè§„åˆ™\nsudo iptables-save > /etc/iptables/rules.v4\n```\n\n### æ•°æ®å®‰å…¨\n\n- å®šæœŸå¤‡ä»½æ•°æ®\n- åŠ å¯†æ•æ„Ÿé…ç½®\n- ä½¿ç”¨å¼ºå¯†ç ç­–ç•¥\n- é™åˆ¶æ•°æ®åº“è®¿é—®\n- å¯ç”¨å®¡è®¡æ—¥å¿—\n\n## ğŸ“š æ›´å¤šèµ„æº\n\n- [å¾®ä¿¡å…¬ä¼—å·é…ç½®æŒ‡å—](docs/wechat-production-deployment.md)\n- [APIæ–‡æ¡£](https://yourdomain.com/api-docs)\n- [ç›‘æ§ä»ªè¡¨æ¿](https://yourdomain.com:3001)\n- [é¡¹ç›®ä»“åº“](https://github.com/your-org/intelligent-work-assistant)\n\n## ğŸ†˜ æŠ€æœ¯æ”¯æŒ\n\nå¦‚é‡åˆ°éƒ¨ç½²é—®é¢˜ï¼š\n\n1. æŸ¥çœ‹æœ¬æ–‡æ¡£çš„æ•…éšœæ’æŸ¥éƒ¨åˆ†\n2. æ£€æŸ¥åº”ç”¨æ—¥å¿—å’Œç³»ç»Ÿæ—¥å¿—\n3. è¿è¡Œé…ç½®æ£€æŸ¥è„šæœ¬\n4. æŸ¥çœ‹é¡¹ç›®Issuesé¡µé¢\n5. è”ç³»æŠ€æœ¯æ”¯æŒå›¢é˜Ÿ\n\n---\n\n**éƒ¨ç½²æˆåŠŸåï¼Œè¯·åŠæ—¶ï¼š**\n\n- âœ… ä¿®æ”¹æ‰€æœ‰é»˜è®¤å¯†ç \n- âœ… é…ç½®ç›‘æ§å‘Šè­¦\n- âœ… è®¾ç½®å¤‡ä»½ç­–ç•¥\n- âœ… æ›´æ–°DNSè§£æ\n- âœ… æµ‹è¯•æ‰€æœ‰åŠŸèƒ½\n- âœ… é…ç½®å®‰å…¨ç­–ç•¥\n\nğŸ‰ **æ­å–œï¼æ™ºèƒ½å·¥ä½œåŠ©æ‰‹å·²æˆåŠŸéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼**