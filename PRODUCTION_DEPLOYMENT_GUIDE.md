# 生产环境部署指南\n\n智能工作助手应用生产环境部署完整指南。\n\n## 📋 目录\n\n- [概述](#概述)\n- [系统要求](#系统要求)\n- [部署前准备](#部署前准备)\n- [快速部署](#快速部署)\n- [详细配置](#详细配置)\n- [监控和维护](#监控和维护)\n- [故障排查](#故障排查)\n- [安全加固](#安全加固)\n\n## 🎯 概述\n\n本指南提供了智能工作助手应用在生产环境中的完整部署方案，包括：\n\n- **容器化部署**: 使用Docker和Docker Compose\n- **服务编排**: MongoDB、Redis、Node.js后端、React前端、Nginx反向代理\n- **监控体系**: Prometheus + Grafana + Loki日志聚合\n- **自动化部署**: 一键部署脚本和CI/CD集成\n- **安全防护**: SSL、防火墙、访问控制\n\n## 💻 系统要求\n\n### 硬件要求\n\n| 组件 | 最低配置 | 推荐配置 |\n|------|----------|----------|\n| CPU | 2核 | 4核+ |\n| 内存 | 4GB | 8GB+ |\n| 存储 | 50GB | 100GB+ SSD |\n| 网络 | 10Mbps | 100Mbps+ |\n\n### 软件要求\n\n- **操作系统**: Ubuntu 20.04+ / CentOS 8+ / Debian 11+\n- **Docker**: 20.10+\n- **Docker Compose**: 2.0+\n- **SSL证书**: Let's Encrypt或商业证书\n- **域名**: 已解析到服务器IP\n\n### 网络要求\n\n- **入站端口**: 80 (HTTP), 443 (HTTPS), 22 (SSH)\n- **出站端口**: 80, 443 (访问微信API和其他外部服务)\n\n## 🚀 部署前准备\n\n### 1. 服务器初始化\n\n```bash\n# 更新系统\nsudo apt update && sudo apt upgrade -y\n\n# 安装必要工具\nsudo apt install -y curl wget git vim htop ufw fail2ban\n\n# 配置防火墙\nsudo ufw allow ssh\nsudo ufw allow http\nsudo ufw allow https\nsudo ufw --force enable\n```\n\n### 2. 安装Docker\n\n```bash\n# 安装Docker\ncurl -fsSL https://get.docker.com -o get-docker.sh\nsudo sh get-docker.sh\n\n# 添加当前用户到docker组\nsudo usermod -aG docker $USER\n\n# 安装Docker Compose\nsudo curl -L \"https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)\" -o /usr/local/bin/docker-compose\nsudo chmod +x /usr/local/bin/docker-compose\n\n# 重启并测试\nsudo systemctl enable docker\nsudo systemctl start docker\ndocker --version\ndocker-compose --version\n```\n\n### 3. 创建项目目录\n\n```bash\n# 创建项目目录\nsudo mkdir -p /opt/iwa\nsudo chown $USER:$USER /opt/iwa\ncd /opt/iwa\n\n# 克隆项目代码\ngit clone <your-repository-url> .\n```\n\n### 4. 获取SSL证书\n\n```bash\n# 安装Certbot\nsudo apt install -y certbot python3-certbot-nginx\n\n# 获取证书（替换yourdomain.com为你的域名）\nsudo certbot certonly --standalone -d yourdomain.com -d www.yourdomain.com\n\n# 复制证书到项目目录\nsudo mkdir -p /opt/iwa/nginx/ssl\nsudo cp /etc/letsencrypt/live/yourdomain.com/fullchain.pem /opt/iwa/nginx/ssl/\nsudo cp /etc/letsencrypt/live/yourdomain.com/privkey.pem /opt/iwa/nginx/ssl/\nsudo chown -R $USER:$USER /opt/iwa/nginx/ssl\n```\n\n## ⚡ 快速部署\n\n### 1. 配置环境变量\n\n```bash\ncd /opt/iwa\n\n# 复制环境配置模板\ncp server/.env.production.example server/.env.production\n\n# 编辑配置文件\nvim server/.env.production\n```\n\n**必须配置的关键变量**:\n\n```bash\n# 基础配置\nBASE_URL=https://yourdomain.com\n\n# 数据库密码\nMONGO_ROOT_PASSWORD=your-secure-mongo-password\nREDIS_PASSWORD=your-secure-redis-password\n\n# 安全密钥（使用下面的命令生成）\nJWT_SECRET=your-jwt-secret\nSESSION_SECRET=your-session-secret\nWECHAT_CONFIG_KEY=your-wechat-config-key\n\n# 微信公众号配置\nWECHAT_APPID=your-wechat-app-id\nWECHAT_APPSECRET=your-wechat-app-secret\nWECHAT_TOKEN=your-wechat-token\nWECHAT_ENCODING_AES_KEY=your-encoding-aes-key\n\n# Grafana管理员密码\nGRAFANA_ADMIN_PASSWORD=your-grafana-password\n```\n\n**生成安全密钥**:\n\n```bash\n# 生成强随机密钥\nnode -e \"console.log('JWT_SECRET=' + require('crypto').randomBytes(64).toString('hex'))\"\nnode -e \"console.log('SESSION_SECRET=' + require('crypto').randomBytes(32).toString('hex'))\"\nnode -e \"console.log('WECHAT_CONFIG_KEY=' + require('crypto').randomBytes(32).toString('hex'))\"\n```\n\n### 2. 运行部署脚本\n\n```bash\n# 运行自动化部署脚本\n./scripts/production-deploy.sh\n```\n\n### 3. 验证部署\n\n```bash\n# 检查服务状态\ndocker-compose -f docker-compose.production.yml ps\n\n# 查看服务日志\ndocker-compose -f docker-compose.production.yml logs -f\n\n# 测试服务\ncurl http://localhost/health\ncurl https://yourdomain.com/api/health\n```\n\n## ⚙️ 详细配置\n\n### 监控配置\n\n#### Prometheus配置\n\n创建 `monitoring/prometheus.yml`:\n\n```yaml\nglobal:\n  scrape_interval: 15s\n  evaluation_interval: 15s\n\nrule_files:\n  - \"rules/*.yml\"\n\nscrape_configs:\n  - job_name: 'nodejs-app'\n    static_configs:\n      - targets: ['backend:5000']\n    metrics_path: '/metrics'\n    scrape_interval: 30s\n\n  - job_name: 'nginx'\n    static_configs:\n      - targets: ['nginx:80']\n    metrics_path: '/nginx_status'\n    scrape_interval: 30s\n\n  - job_name: 'mongodb'\n    static_configs:\n      - targets: ['mongodb:27017']\n\n  - job_name: 'redis'\n    static_configs:\n      - targets: ['redis:6379']\n```\n\n#### Grafana仪表板\n\n访问 `https://yourdomain.com:3001` 配置Grafana:\n\n1. 使用配置的管理员密码登录\n2. 添加Prometheus数据源: `http://prometheus:9090`\n3. 导入预配置的仪表板\n4. 配置告警规则\n\n### 备份策略\n\n#### 自动备份配置\n\n```bash\n# 创建备份脚本\ncat > /opt/iwa/scripts/backup.sh << 'EOF'\n#!/bin/bash\n\nBACKUP_DIR=\"/opt/iwa/backups/$(date +%Y%m%d-%H%M%S)\"\nmkdir -p \"$BACKUP_DIR\"\n\n# 备份数据库\ndocker exec iwa-mongodb-prod mongodump --out /tmp/backup\ndocker cp iwa-mongodb-prod:/tmp/backup \"$BACKUP_DIR/mongodb\"\n\n# 备份应用数据\ncp -r /opt/iwa/data/uploads \"$BACKUP_DIR/\"\ncp -r /opt/iwa/data/app \"$BACKUP_DIR/\"\n\n# 清理旧备份（保留7天）\nfind /opt/iwa/backups -type d -mtime +7 -exec rm -rf {} +\n\necho \"Backup completed: $BACKUP_DIR\"\nEOF\n\nchmod +x /opt/iwa/scripts/backup.sh\n\n# 添加到crontab\n(crontab -l 2>/dev/null; echo \"0 2 * * * /opt/iwa/scripts/backup.sh\") | crontab -\n```\n\n### 日志管理\n\n#### 配置日志轮转\n\n```bash\n# 创建logrotate配置\nsudo tee /etc/logrotate.d/intelligent-work-assistant << 'EOF'\n/opt/iwa/logs/*.log {\n    daily\n    missingok\n    rotate 30\n    compress\n    delaycompress\n    notifempty\n    create 644 root root\n    postrotate\n        docker-compose -f /opt/iwa/docker-compose.production.yml restart nginx\n    endscript\n}\nEOF\n```\n\n### SSL证书自动续期\n\n```bash\n# 创建证书续期脚本\ncat > /opt/iwa/scripts/renew-ssl.sh << 'EOF'\n#!/bin/bash\n\n# 续期证书\nsudo certbot renew --quiet\n\n# 更新项目中的证书\nif [ -f \"/etc/letsencrypt/live/yourdomain.com/fullchain.pem\" ]; then\n    sudo cp /etc/letsencrypt/live/yourdomain.com/fullchain.pem /opt/iwa/nginx/ssl/\n    sudo cp /etc/letsencrypt/live/yourdomain.com/privkey.pem /opt/iwa/nginx/ssl/\n    \n    # 重启nginx\n    docker-compose -f /opt/iwa/docker-compose.production.yml restart nginx\n    \n    echo \"SSL证书已更新\"\nfi\nEOF\n\nchmod +x /opt/iwa/scripts/renew-ssl.sh\n\n# 添加到crontab（每月检查一次）\n(crontab -l 2>/dev/null; echo \"0 3 1 * * /opt/iwa/scripts/renew-ssl.sh\") | crontab -\n```\n\n## 📊 监控和维护\n\n### 服务健康监控\n\n```bash\n# 检查所有服务状态\ndocker-compose -f docker-compose.production.yml ps\n\n# 查看服务资源使用情况\ndocker stats\n\n# 查看系统资源\nhtop\ndf -h\nfree -m\n```\n\n### 性能监控指标\n\n- **应用指标**: 响应时间、请求量、错误率\n- **系统指标**: CPU、内存、磁盘、网络使用率\n- **业务指标**: 用户活跃度、任务完成率、微信消息处理量\n\n### 告警配置\n\n在Grafana中配置以下告警规则：\n\n- CPU使用率 > 80%\n- 内存使用率 > 85%\n- 磁盘使用率 > 90%\n- API响应时间 > 3秒\n- 错误率 > 5%\n\n## 🔧 故障排查\n\n### 常见问题\n\n#### 1. 服务无法启动\n\n```bash\n# 查看服务日志\ndocker-compose -f docker-compose.production.yml logs [service-name]\n\n# 检查配置文件\ndocker-compose -f docker-compose.production.yml config\n\n# 重启特定服务\ndocker-compose -f docker-compose.production.yml restart [service-name]\n```\n\n#### 2. 数据库连接失败\n\n```bash\n# 检查MongoDB状态\ndocker exec iwa-mongodb-prod mongosh --eval \"db.adminCommand('ping')\"\n\n# 检查Redis状态\ndocker exec iwa-redis-prod redis-cli ping\n\n# 检查网络连接\ndocker-compose -f docker-compose.production.yml exec backend ping mongodb\n```\n\n#### 3. 微信接口问题\n\n```bash\n# 运行微信配置检查\ndocker exec iwa-backend-prod node scripts/wechat-production-check.js\n\n# 查看微信相关日志\ndocker-compose -f docker-compose.production.yml logs backend | grep -i wechat\n\n# 测试微信API连接\ncurl -X POST \"https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=YOUR_APPID&secret=YOUR_SECRET\"\n```\n\n#### 4. SSL证书问题\n\n```bash\n# 检查证书有效期\nopenssl x509 -in /opt/iwa/nginx/ssl/fullchain.pem -text -noout | grep -A2 \"Validity\"\n\n# 测试HTTPS连接\ncurl -I https://yourdomain.com\n\n# 检查证书链\nopenssl s_client -connect yourdomain.com:443 -servername yourdomain.com\n```\n\n### 紧急恢复\n\n#### 服务回滚\n\n```bash\n# 使用部署脚本回滚\n./scripts/production-deploy.sh --rollback\n\n# 手动回滚到上一个版本\ngit checkout HEAD~1\ndocker-compose -f docker-compose.production.yml down\ndocker-compose -f docker-compose.production.yml up -d\n```\n\n#### 数据恢复\n\n```bash\n# 查找可用备份\nls -la /opt/iwa/backups/\n\n# 恢复数据库\ndocker exec -i iwa-mongodb-prod mongorestore /backup/path\n\n# 恢复文件\ncp -r /opt/iwa/backups/latest/uploads /opt/iwa/data/\n```\n\n## 🔒 安全加固\n\n### 系统安全\n\n```bash\n# 配置fail2ban\nsudo systemctl enable fail2ban\nsudo systemctl start fail2ban\n\n# 更新系统\nsudo apt update && sudo apt upgrade -y\n\n# 配置自动安全更新\nsudo apt install -y unattended-upgrades\nsudo dpkg-reconfigure unattended-upgrades\n```\n\n### 应用安全\n\n```bash\n# 定期更新Docker镜像\ndocker-compose -f docker-compose.production.yml pull\ndocker-compose -f docker-compose.production.yml up -d\n\n# 扫描安全漏洞\ndocker run --rm -v /var/run/docker.sock:/var/run/docker.sock \\\n  -v \"$PWD:/tmp/clair-scanner-logs\" \\\n  aquasec/trivy image your-image-name\n```\n\n### 网络安全\n\n```bash\n# 配置iptables规则\nsudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT\nsudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT\nsudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT\nsudo iptables -A INPUT -j DROP\n\n# 保存iptables规则\nsudo iptables-save > /etc/iptables/rules.v4\n```\n\n### 数据安全\n\n- 定期备份数据\n- 加密敏感配置\n- 使用强密码策略\n- 限制数据库访问\n- 启用审计日志\n\n## 📚 更多资源\n\n- [微信公众号配置指南](docs/wechat-production-deployment.md)\n- [API文档](https://yourdomain.com/api-docs)\n- [监控仪表板](https://yourdomain.com:3001)\n- [项目仓库](https://github.com/your-org/intelligent-work-assistant)\n\n## 🆘 技术支持\n\n如遇到部署问题：\n\n1. 查看本文档的故障排查部分\n2. 检查应用日志和系统日志\n3. 运行配置检查脚本\n4. 查看项目Issues页面\n5. 联系技术支持团队\n\n---\n\n**部署成功后，请及时：**\n\n- ✅ 修改所有默认密码\n- ✅ 配置监控告警\n- ✅ 设置备份策略\n- ✅ 更新DNS解析\n- ✅ 测试所有功能\n- ✅ 配置安全策略\n\n🎉 **恭喜！智能工作助手已成功部署到生产环境！**