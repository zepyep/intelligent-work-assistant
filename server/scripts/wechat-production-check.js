#!/usr/bin/env node\n\n/**\n * å¾®ä¿¡å…¬ä¼—å·ç”Ÿäº§ç¯å¢ƒé…ç½®æ£€æŸ¥è„šæœ¬\n * ç”¨äºéªŒè¯ç”Ÿäº§ç¯å¢ƒçš„å¾®ä¿¡é…ç½®æ˜¯å¦æ­£ç¡®\n */\n\nconst WechatProductionConfig = require('../config/wechat-production');\nconst crypto = require('crypto');\n\nclass WechatProductionChecker {\n  constructor() {\n    this.wechatConfig = new WechatProductionConfig();\n    this.results = {\n      overall: false,\n      checks: []\n    };\n  }\n\n  /**\n   * æ‰§è¡Œæ‰€æœ‰æ£€æŸ¥\n   */\n  async runAllChecks() {\n    console.log('\\nğŸ” å¾®ä¿¡å…¬ä¼—å·ç”Ÿäº§ç¯å¢ƒé…ç½®æ£€æŸ¥\\n');\n    \n    await this.checkBasicConfig();\n    await this.checkEnvironmentVariables();\n    await this.checkWebhookURL();\n    await this.checkMenuConfiguration();\n    \n    this.printSummary();\n    this.generateReport();\n    \n    return this.results;\n  }\n\n  /**\n   * æ£€æŸ¥åŸºæœ¬é…ç½®\n   */\n  async checkBasicConfig() {\n    const check = {\n      name: 'åŸºæœ¬é…ç½®æ£€æŸ¥',\n      status: 'checking',\n      details: []\n    };\n    \n    try {\n      const validation = this.wechatConfig.validateConfig();\n      const status = this.wechatConfig.getConfigStatus();\n      \n      if (validation.valid) {\n        check.status = 'passed';\n        check.details.push('âœ… æ‰€æœ‰å¿…è¦é…ç½®é¡¹å·²å®Œæˆ');\n        check.details.push(`âœ… AppID: ${status.appId}`);\n        check.details.push(`âœ… AppSecret: ${status.appSecret}`);\n        check.details.push(`âœ… Token: ${status.token}`);\n        \n        if (status.encodingAESKey !== 'æœªé…ç½®') {\n          check.details.push(`âœ… EncodingAESKey: ${status.encodingAESKey}`);\n        }\n        \n        this.logPass(check.name);\n      } else {\n        check.status = 'failed';\n        check.details.push(`âŒ é…ç½®éªŒè¯å¤±è´¥: ${validation.message}`);\n        \n        if (validation.missingFields) {\n          validation.missingFields.forEach(field => {\n            check.details.push(`âŒ ç¼ºå°‘é…ç½®: ${field}`);\n          });\n        }\n        \n        this.logError(check.name, validation.message);\n      }\n    } catch (error) {\n      check.status = 'error';\n      check.details.push(`ğŸ’¥ æ£€æŸ¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`);\n      this.logError(check.name, error.message);\n    }\n    \n    this.results.checks.push(check);\n  }\n\n  /**\n   * æ£€æŸ¥ç¯å¢ƒå˜é‡\n   */\n  async checkEnvironmentVariables() {\n    const check = {\n      name: 'ç¯å¢ƒå˜é‡æ£€æŸ¥',\n      status: 'checking',\n      details: []\n    };\n    \n    const envVars = {\n      'WECHAT_APPID': process.env.WECHAT_APPID || process.env.WECHAT_APP_ID,\n      'WECHAT_APPSECRET': process.env.WECHAT_APPSECRET || process.env.WECHAT_APP_SECRET,\n      'WECHAT_TOKEN': process.env.WECHAT_TOKEN,\n      'BASE_URL': process.env.BASE_URL,\n      'NODE_ENV': process.env.NODE_ENV\n    };\n    \n    let allPassed = true;\n    \n    Object.entries(envVars).forEach(([key, value]) => {\n      if (value) {\n        check.details.push(`âœ… ${key}: å·²è®¾ç½®`);\n      } else {\n        if (key !== 'BASE_URL') {  // BASE_URLæ˜¯å¯é€‰çš„\n          check.details.push(`âŒ ${key}: æœªè®¾ç½®`);\n          allPassed = false;\n        } else {\n          check.details.push(`âš ï¸  ${key}: æœªè®¾ç½® (å¯é€‰)`);\n        }\n      }\n    });\n    \n    // æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒç‰¹å®šé…ç½®\n    if (process.env.NODE_ENV === 'production') {\n      if (!process.env.WECHAT_CONFIG_KEY) {\n        check.details.push('âš ï¸  WECHAT_CONFIG_KEY: å»ºè®®è®¾ç½®ç‹¬ç«‹çš„é…ç½®åŠ å¯†å¯†é’¥');\n      } else {\n        check.details.push('âœ… WECHAT_CONFIG_KEY: å·²è®¾ç½®');\n      }\n    }\n    \n    check.status = allPassed ? 'passed' : 'failed';\n    \n    if (allPassed) {\n      this.logPass(check.name);\n    } else {\n      this.logError(check.name, 'éƒ¨åˆ†ç¯å¢ƒå˜é‡æœªè®¾ç½®');\n    }\n    \n    this.results.checks.push(check);\n  }\n\n  /**\n   * æ£€æŸ¥Webhook URL\n   */\n  async checkWebhookURL() {\n    const check = {\n      name: 'Webhook URLæ£€æŸ¥',\n      status: 'checking',\n      details: []\n    };\n    \n    const config = this.wechatConfig.config;\n    const webhookUrl = config.serverUrl;\n    \n    if (!webhookUrl) {\n      check.status = 'failed';\n      check.details.push('âŒ Webhook URLæœªé…ç½®');\n      this.logError(check.name, 'URLæœªé…ç½®');\n      this.results.checks.push(check);\n      return;\n    }\n    \n    check.details.push(`âœ… URLå·²é…ç½®: ${webhookUrl}`);\n    check.status = 'passed';\n    this.logPass(check.name);\n    \n    this.results.checks.push(check);\n  }\n\n  /**\n   * æ£€æŸ¥èœå•é…ç½®\n   */\n  async checkMenuConfiguration() {\n    const check = {\n      name: 'èœå•é…ç½®æ£€æŸ¥',\n      status: 'checking',\n      details: []\n    };\n    \n    const config = this.wechatConfig.config;\n    \n    if (config.menuConfig) {\n      check.details.push('âœ… è‡ªå®šä¹‰èœå•é…ç½®å­˜åœ¨');\n      \n      const menuConfig = config.menuConfig;\n      if (menuConfig.button && Array.isArray(menuConfig.button)) {\n        check.details.push(`âœ… èœå•æŒ‰é’®æ•°é‡: ${menuConfig.button.length}`);\n        \n        menuConfig.button.forEach((button, index) => {\n          check.details.push(`âœ… èœå•${index + 1}: ${button.name}`);\n          if (button.sub_button) {\n            check.details.push(`   â””â”€ å­èœå•æ•°é‡: ${button.sub_button.length}`);\n          }\n        });\n        \n        check.status = 'passed';\n        this.logPass(check.name);\n      } else {\n        check.status = 'failed';\n        check.details.push('âŒ èœå•é…ç½®æ ¼å¼é”™è¯¯');\n        this.logError(check.name, 'èœå•æ ¼å¼é”™è¯¯');\n      }\n    } else {\n      check.status = 'warning';\n      check.details.push('âš ï¸  æœªé…ç½®è‡ªå®šä¹‰èœå•ï¼ˆå°†ä½¿ç”¨é»˜è®¤èœå•ï¼‰');\n      this.logWarning(check.name, 'ä½¿ç”¨é»˜è®¤èœå•');\n    }\n    \n    this.results.checks.push(check);\n  }\n\n  /**\n   * æ‰“å°æ£€æŸ¥ç»“æœæ‘˜è¦\n   */\n  printSummary() {\n    console.log('\\nğŸ“Š æ£€æŸ¥ç»“æœæ‘˜è¦\\n');\n    \n    const passed = this.results.checks.filter(c => c.status === 'passed').length;\n    const failed = this.results.checks.filter(c => c.status === 'failed').length;\n    const errors = this.results.checks.filter(c => c.status === 'error').length;\n    const warnings = this.results.checks.filter(c => c.status === 'warning').length;\n    \n    console.log(`âœ… é€šè¿‡: ${passed}`);\n    console.log(`âŒ å¤±è´¥: ${failed}`);\n    console.log(`ğŸ’¥ é”™è¯¯: ${errors}`);\n    console.log(`âš ï¸  è­¦å‘Š: ${warnings}`);\n    \n    this.results.overall = failed === 0 && errors === 0;\n    \n    if (this.results.overall) {\n      console.log('\\nğŸ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼å¾®ä¿¡å…¬ä¼—å·é…ç½®å°±ç»ª\\n');\n    } else {\n      console.log('\\nâš ï¸  å­˜åœ¨é…ç½®é—®é¢˜ï¼Œéœ€è¦ä¿®å¤åæ‰èƒ½æ­£å¸¸ä½¿ç”¨\\n');\n    }\n  }\n\n  /**\n   * ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š\n   */\n  generateReport() {\n    const report = {\n      timestamp: new Date().toISOString(),\n      environment: process.env.NODE_ENV || 'development',\n      overall: this.results.overall,\n      summary: {\n        total: this.results.checks.length,\n        passed: this.results.checks.filter(c => c.status === 'passed').length,\n        failed: this.results.checks.filter(c => c.status === 'failed').length,\n        errors: this.results.checks.filter(c => c.status === 'error').length,\n        warnings: this.results.checks.filter(c => c.status === 'warning').length\n      },\n      checks: this.results.checks,\n      recommendations: this.getRecommendations()\n    };\n    \n    const fs = require('fs');\n    const path = require('path');\n    const reportPath = path.join(__dirname, '../data/wechat-check-report.json');\n    \n    // ç¡®ä¿ç›®å½•å­˜åœ¨\n    const dir = path.dirname(reportPath);\n    if (!fs.existsSync(dir)) {\n      fs.mkdirSync(dir, { recursive: true });\n    }\n    \n    fs.writeFileSync(reportPath, JSON.stringify(report, null, 2));\n    console.log(`ğŸ“„ è¯¦ç»†æŠ¥å‘Šå·²ä¿å­˜åˆ°: ${reportPath}`);\n  }\n\n  /**\n   * è·å–ä¿®å¤å»ºè®®\n   */\n  getRecommendations() {\n    const recommendations = [];\n    \n    this.results.checks.forEach(check => {\n      if (check.status === 'failed' || check.status === 'error') {\n        switch (check.name) {\n          case 'åŸºæœ¬é…ç½®æ£€æŸ¥':\n            recommendations.push('è¯·å®Œæˆå¾®ä¿¡å…¬ä¼—å·çš„åŸºæœ¬é…ç½®ï¼ˆAppIDã€AppSecretã€Tokenï¼‰');\n            recommendations.push('å‚è€ƒæ–‡æ¡£: docs/wechat-setup-guide.md');\n            break;\n          case 'ç¯å¢ƒå˜é‡æ£€æŸ¥':\n            recommendations.push('è¯·è®¾ç½®ç›¸åº”çš„ç¯å¢ƒå˜é‡æˆ–ä½¿ç”¨é…ç½®ç®¡ç†ç•Œé¢');\n            break;\n          case 'Webhook URLæ£€æŸ¥':\n            recommendations.push('è¯·ç¡®ä¿æœåŠ¡å™¨URLå¯è¢«å¤–ç½‘è®¿é—®');\n            recommendations.push('è¯·åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°é…ç½®æ­£ç¡®çš„æœåŠ¡å™¨åœ°å€');\n            break;\n        }\n      }\n    });\n    \n    return recommendations;\n  }\n\n  // æ—¥å¿—è¾“å‡ºæ–¹æ³•\n  logPass(checkName) {\n    console.log(`âœ… ${checkName} - é€šè¿‡`);\n  }\n  \n  logError(checkName, message) {\n    console.log(`âŒ ${checkName} - å¤±è´¥: ${message}`);\n  }\n  \n  logWarning(checkName, message) {\n    console.log(`âš ï¸  ${checkName} - è­¦å‘Š: ${message}`);\n  }\n}\n\n// å¦‚æœç›´æ¥è¿è¡Œæ­¤è„šæœ¬\nif (require.main === module) {\n  const checker = new WechatProductionChecker();\n  \n  checker.runAllChecks().then((results) => {\n    process.exit(results.overall ? 0 : 1);\n  }).catch((error) => {\n    console.error('æ£€æŸ¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);\n    process.exit(1);\n  });\n}\n\nmodule.exports = WechatProductionChecker;