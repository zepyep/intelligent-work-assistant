const jwt = require('jsonwebtoken');\nconst User = require('../models/User');\nconst encryptionService = require('../services/encryptionService');\n\n/**\n * è®¿é—®æ§åˆ¶å’Œæƒé™ç®¡ç†ä¸­é—´ä»¶\n */\n\n// æƒé™çº§åˆ«å®šä¹‰\nconst PERMISSIONS = {\n  // ç³»ç»Ÿæƒé™\n  SYSTEM_ADMIN: 'system:admin',\n  SYSTEM_CONFIG: 'system:config',\n  SYSTEM_MONITOR: 'system:monitor',\n  \n  // ç”¨æˆ·ç®¡ç†æƒé™\n  USER_READ: 'user:read',\n  USER_WRITE: 'user:write',\n  USER_DELETE: 'user:delete',\n  USER_ADMIN: 'user:admin',\n  \n  // ä»»åŠ¡æƒé™\n  TASK_READ: 'task:read',\n  TASK_WRITE: 'task:write',\n  TASK_DELETE: 'task:delete',\n  TASK_ASSIGN: 'task:assign',\n  \n  // æ–‡æ¡£æƒé™\n  DOCUMENT_READ: 'document:read',\n  DOCUMENT_WRITE: 'document:write',\n  DOCUMENT_DELETE: 'document:delete',\n  DOCUMENT_SHARE: 'document:share',\n  \n  // ä¼šè®®æƒé™\n  MEETING_READ: 'meeting:read',\n  MEETING_WRITE: 'meeting:write',\n  MEETING_DELETE: 'meeting:delete',\n  MEETING_MANAGE: 'meeting:manage',\n  \n  // AIåŠŸèƒ½æƒé™\n  AI_USE: 'ai:use',\n  AI_ADMIN: 'ai:admin',\n  \n  // WeChatæƒé™\n  WECHAT_USE: 'wechat:use',\n  WECHAT_ADMIN: 'wechat:admin',\n  \n  // é€šçŸ¥æƒé™\n  NOTIFICATION_READ: 'notification:read',\n  NOTIFICATION_SEND: 'notification:send',\n  NOTIFICATION_ADMIN: 'notification:admin'\n};\n\n// è§’è‰²æƒé™æ˜ å°„\nconst ROLE_PERMISSIONS = {\n  super_admin: [\n    PERMISSIONS.SYSTEM_ADMIN,\n    PERMISSIONS.SYSTEM_CONFIG,\n    PERMISSIONS.SYSTEM_MONITOR,\n    PERMISSIONS.USER_ADMIN,\n    PERMISSIONS.AI_ADMIN,\n    PERMISSIONS.WECHAT_ADMIN,\n    PERMISSIONS.NOTIFICATION_ADMIN,\n    ...Object.values(PERMISSIONS)\n  ],\n  admin: [\n    PERMISSIONS.SYSTEM_MONITOR,\n    PERMISSIONS.USER_READ,\n    PERMISSIONS.USER_WRITE,\n    PERMISSIONS.TASK_READ,\n    PERMISSIONS.TASK_WRITE,\n    PERMISSIONS.TASK_DELETE,\n    PERMISSIONS.TASK_ASSIGN,\n    PERMISSIONS.DOCUMENT_READ,\n    PERMISSIONS.DOCUMENT_WRITE,\n    PERMISSIONS.DOCUMENT_DELETE,\n    PERMISSIONS.DOCUMENT_SHARE,\n    PERMISSIONS.MEETING_READ,\n    PERMISSIONS.MEETING_WRITE,\n    PERMISSIONS.MEETING_DELETE,\n    PERMISSIONS.MEETING_MANAGE,\n    PERMISSIONS.AI_USE,\n    PERMISSIONS.WECHAT_USE,\n    PERMISSIONS.NOTIFICATION_READ,\n    PERMISSIONS.NOTIFICATION_SEND\n  ],\n  manager: [\n    PERMISSIONS.USER_READ,\n    PERMISSIONS.TASK_READ,\n    PERMISSIONS.TASK_WRITE,\n    PERMISSIONS.TASK_ASSIGN,\n    PERMISSIONS.DOCUMENT_READ,\n    PERMISSIONS.DOCUMENT_WRITE,\n    PERMISSIONS.DOCUMENT_SHARE,\n    PERMISSIONS.MEETING_READ,\n    PERMISSIONS.MEETING_WRITE,\n    PERMISSIONS.MEETING_MANAGE,\n    PERMISSIONS.AI_USE,\n    PERMISSIONS.WECHAT_USE,\n    PERMISSIONS.NOTIFICATION_READ,\n    PERMISSIONS.NOTIFICATION_SEND\n  ],\n  user: [\n    PERMISSIONS.USER_READ, // åªèƒ½è¯»å–è‡ªå·±çš„ä¿¡æ¯\n    PERMISSIONS.TASK_READ,\n    PERMISSIONS.TASK_WRITE, // åªèƒ½æ“ä½œè‡ªå·±çš„ä»»åŠ¡\n    PERMISSIONS.DOCUMENT_READ,\n    PERMISSIONS.DOCUMENT_WRITE, // åªèƒ½æ“ä½œè‡ªå·±çš„æ–‡æ¡£\n    PERMISSIONS.MEETING_READ,\n    PERMISSIONS.MEETING_WRITE, // åªèƒ½æ“ä½œè‡ªå·±å‚ä¸çš„ä¼šè®®\n    PERMISSIONS.AI_USE,\n    PERMISSIONS.WECHAT_USE,\n    PERMISSIONS.NOTIFICATION_READ\n  ]\n};\n\n// èµ„æºæ‰€æœ‰æƒæ£€æŸ¥\nconst RESOURCE_OWNERSHIP = {\n  task: 'createdBy',\n  document: 'uploadedBy',\n  meeting: 'createdBy',\n  notification: 'recipientId'\n};\n\n/**\n * JWT TokenéªŒè¯ä¸­é—´ä»¶\n */\nconst authenticateToken = async (req, res, next) => {\n  try {\n    let token = req.headers.authorization;\n    \n    if (!token) {\n      return res.status(401).json({\n        success: false,\n        error: 'è®¿é—®ä»¤ç‰Œç¼ºå¤±',\n        code: 'TOKEN_MISSING'\n      });\n    }\n    \n    // æå–Bearer token\n    if (token.startsWith('Bearer ')) {\n      token = token.slice(7);\n    }\n    \n    // éªŒè¯JWT\n    const decoded = jwt.verify(token, process.env.JWT_SECRET);\n    \n    // è·å–ç”¨æˆ·ä¿¡æ¯\n    const user = await User.findById(decoded.userId).select('-password');\n    if (!user) {\n      return res.status(401).json({\n        success: false,\n        error: 'ç”¨æˆ·ä¸å­˜åœ¨',\n        code: 'USER_NOT_FOUND'\n      });\n    }\n    \n    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¢«ç¦ç”¨\n    if (!user.isActive) {\n      return res.status(401).json({\n        success: false,\n        error: 'ç”¨æˆ·è´¦å·å·²è¢«ç¦ç”¨',\n        code: 'USER_DISABLED'\n      });\n    }\n    \n    // å°†ç”¨æˆ·ä¿¡æ¯é™„åŠ åˆ°è¯·æ±‚å¯¹è±¡\n    req.user = user;\n    req.token = token;\n    \n    next();\n  } catch (error) {\n    if (error.name === 'TokenExpiredError') {\n      return res.status(401).json({\n        success: false,\n        error: 'è®¿é—®ä»¤ç‰Œå·²è¿‡æœŸ',\n        code: 'TOKEN_EXPIRED'\n      });\n    }\n    \n    if (error.name === 'JsonWebTokenError') {\n      return res.status(401).json({\n        success: false,\n        error: 'æ— æ•ˆçš„è®¿é—®ä»¤ç‰Œ',\n        code: 'INVALID_TOKEN'\n      });\n    }\n    \n    return res.status(500).json({\n      success: false,\n      error: 'è®¤è¯éªŒè¯å¤±è´¥',\n      code: 'AUTH_ERROR'\n    });\n  }\n};\n\n/**\n * æƒé™æ£€æŸ¥ä¸­é—´ä»¶å·¥å‚\n * @param {string|array} requiredPermissions æ‰€éœ€æƒé™\n * @param {object} options é¢å¤–é€‰é¡¹\n */\nconst requirePermissions = (requiredPermissions, options = {}) => {\n  const permissions = Array.isArray(requiredPermissions) ? \n    requiredPermissions : [requiredPermissions];\n  \n  return async (req, res, next) => {\n    try {\n      if (!req.user) {\n        return res.status(401).json({\n          success: false,\n          error: 'ç”¨æˆ·æœªè®¤è¯',\n          code: 'USER_NOT_AUTHENTICATED'\n        });\n      }\n      \n      const userPermissions = ROLE_PERMISSIONS[req.user.role] || [];\n      \n      // æ£€æŸ¥æ˜¯å¦æœ‰æ‰€éœ€æƒé™\n      const hasPermission = permissions.every(permission => \n        userPermissions.includes(permission)\n      );\n      \n      if (!hasPermission) {\n        return res.status(403).json({\n          success: false,\n          error: 'æƒé™ä¸è¶³',\n          code: 'INSUFFICIENT_PERMISSIONS',\n          requiredPermissions: permissions\n        });\n      }\n      \n      // èµ„æºæ‰€æœ‰æƒæ£€æŸ¥\n      if (options.checkOwnership) {\n        const resourceType = options.resourceType;\n        const resourceId = req.params.id || req.params[`${resourceType}Id`];\n        \n        if (resourceId && !await checkResourceOwnership(req.user, resourceType, resourceId)) {\n          return res.status(403).json({\n            success: false,\n            error: 'æ— æƒè®¿é—®æ­¤èµ„æº',\n            code: 'RESOURCE_ACCESS_DENIED'\n          });\n        }\n      }\n      \n      next();\n    } catch (error) {\n      return res.status(500).json({\n        success: false,\n        error: 'æƒé™æ£€æŸ¥å¤±è´¥',\n        code: 'PERMISSION_CHECK_ERROR'\n      });\n    }\n  };\n};\n\n/**\n * è§’è‰²æ£€æŸ¥ä¸­é—´ä»¶\n * @param {string|array} allowedRoles å…è®¸çš„è§’è‰²\n */\nconst requireRole = (allowedRoles) => {\n  const roles = Array.isArray(allowedRoles) ? allowedRoles : [allowedRoles];\n  \n  return (req, res, next) => {\n    if (!req.user) {\n      return res.status(401).json({\n        success: false,\n        error: 'ç”¨æˆ·æœªè®¤è¯',\n        code: 'USER_NOT_AUTHENTICATED'\n      });\n    }\n    \n    if (!roles.includes(req.user.role)) {\n      return res.status(403).json({\n        success: false,\n        error: 'è§’è‰²æƒé™ä¸è¶³',\n        code: 'ROLE_ACCESS_DENIED',\n        requiredRoles: roles,\n        userRole: req.user.role\n      });\n    }\n    \n    next();\n  };\n};\n\n/**\n * æ£€æŸ¥èµ„æºæ‰€æœ‰æƒ\n * @param {object} user ç”¨æˆ·å¯¹è±¡\n * @param {string} resourceType èµ„æºç±»å‹\n * @param {string} resourceId èµ„æºID\n */\nconst checkResourceOwnership = async (user, resourceType, resourceId) => {\n  try {\n    // ç®¡ç†å‘˜å’Œè¶…çº§ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰èµ„æº\n    if (['admin', 'super_admin'].includes(user.role)) {\n      return true;\n    }\n    \n    const ownershipField = RESOURCE_OWNERSHIP[resourceType];\n    if (!ownershipField) {\n      return false;\n    }\n    \n    // åŠ¨æ€å¯¼å…¥ç›¸å…³æ¨¡å‹\n    let Model;\n    switch (resourceType) {\n      case 'task':\n        Model = require('../models/Task');\n        break;\n      case 'document':\n        Model = require('../models/Document');\n        break;\n      case 'meeting':\n        Model = require('../models/Meeting');\n        break;\n      case 'notification':\n        Model = require('../models/Notification');\n        break;\n      default:\n        return false;\n    }\n    \n    const resource = await Model.findById(resourceId);\n    if (!resource) {\n      return false;\n    }\n    \n    return resource[ownershipField].toString() === user._id.toString();\n  } catch (error) {\n    console.error('èµ„æºæ‰€æœ‰æƒæ£€æŸ¥é”™è¯¯:', error);\n    return false;\n  }\n};\n\n/**\n * ä¼šè¯ç®¡ç†ä¸­é—´ä»¶\n */\nconst sessionManager = {\n  // åˆ›å»ºä¼šè¯\n  createSession: (req, res, next) => {\n    const sessionId = encryptionService.generateSessionId();\n    req.sessionId = sessionId;\n    \n    // è®¾ç½®ä¼šè¯cookie\n    res.cookie('sessionId', sessionId, {\n      httpOnly: true,\n      secure: process.env.NODE_ENV === 'production',\n      maxAge: 24 * 60 * 60 * 1000, // 24å°æ—¶\n      sameSite: 'strict'\n    });\n    \n    next();\n  },\n  \n  // éªŒè¯ä¼šè¯\n  validateSession: (req, res, next) => {\n    const sessionId = req.cookies.sessionId || req.headers['x-session-id'];\n    \n    if (!sessionId) {\n      return res.status(401).json({\n        success: false,\n        error: 'ä¼šè¯IDç¼ºå¤±',\n        code: 'SESSION_MISSING'\n      });\n    }\n    \n    // è¿™é‡Œå¯ä»¥æ·»åŠ ä¼šè¯å­˜å‚¨éªŒè¯é€»è¾‘ï¼ˆRedisç­‰ï¼‰\n    req.sessionId = sessionId;\n    next();\n  },\n  \n  // æ¸…é™¤ä¼šè¯\n  clearSession: (req, res, next) => {\n    res.clearCookie('sessionId');\n    next();\n  }\n};\n\n/**\n * APIè®¿é—®æ—¥å¿—ä¸­é—´ä»¶\n */\nconst auditLogger = (req, res, next) => {\n  const startTime = Date.now();\n  \n  // è®°å½•è¯·æ±‚ä¿¡æ¯\n  const logData = {\n    timestamp: new Date().toISOString(),\n    method: req.method,\n    path: req.path,\n    ip: req.ip || req.connection.remoteAddress,\n    userAgent: req.get('User-Agent'),\n    userId: req.user?.id,\n    sessionId: req.sessionId\n  };\n  \n  // ç›‘å¬å“åº”å®Œæˆ\n  res.on('finish', () => {\n    logData.statusCode = res.statusCode;\n    logData.responseTime = Date.now() - startTime;\n    \n    // è®°å½•æ•æ„Ÿæ“ä½œ\n    const sensitivePaths = ['/api/auth', '/api/admin', '/api/wechat-admin'];\n    const isSensitiveOperation = sensitivePaths.some(path => req.path.startsWith(path)) ||\n      ['POST', 'PUT', 'DELETE'].includes(req.method);\n    \n    if (isSensitiveOperation || res.statusCode >= 400) {\n      console.log('ğŸ” APIè®¿é—®æ—¥å¿—:', JSON.stringify(logData, null, 2));\n    }\n  });\n  \n  next();\n};\n\n/**\n * è·å–ç”¨æˆ·æƒé™åˆ—è¡¨\n * @param {object} user ç”¨æˆ·å¯¹è±¡\n * @returns {array} æƒé™åˆ—è¡¨\n */\nconst getUserPermissions = (user) => {\n  return ROLE_PERMISSIONS[user.role] || [];\n};\n\n/**\n * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ç‰¹å®šæƒé™\n * @param {object} user ç”¨æˆ·å¯¹è±¡\n * @param {string} permission æƒé™\n * @returns {boolean} æ˜¯å¦æœ‰æƒé™\n */\nconst hasPermission = (user, permission) => {\n  const userPermissions = getUserPermissions(user);\n  return userPermissions.includes(permission);\n};\n\n/**\n * æƒé™ä¸­é—´ä»¶ç»„åˆå™¨\n * @param {object} options é…ç½®é€‰é¡¹\n */\nconst createPermissionMiddleware = (options) => {\n  const middlewares = [];\n  \n  // è®¤è¯æ£€æŸ¥\n  if (!options.skipAuth) {\n    middlewares.push(authenticateToken);\n  }\n  \n  // æƒé™æ£€æŸ¥\n  if (options.permissions) {\n    middlewares.push(requirePermissions(options.permissions, {\n      checkOwnership: options.checkOwnership,\n      resourceType: options.resourceType\n    }));\n  }\n  \n  // è§’è‰²æ£€æŸ¥\n  if (options.roles) {\n    middlewares.push(requireRole(options.roles));\n  }\n  \n  // å®¡è®¡æ—¥å¿—\n  if (options.auditLog) {\n    middlewares.push(auditLogger);\n  }\n  \n  return middlewares;\n};\n\nmodule.exports = {\n  // æƒé™å¸¸é‡\n  PERMISSIONS,\n  ROLE_PERMISSIONS,\n  \n  // ä¸­é—´ä»¶å‡½æ•°\n  authenticateToken,\n  requirePermissions,\n  requireRole,\n  sessionManager,\n  auditLogger,\n  \n  // å·¥å…·å‡½æ•°\n  checkResourceOwnership,\n  getUserPermissions,\n  hasPermission,\n  createPermissionMiddleware\n};"