name: ðŸš€ æ™ºèƒ½å·¥ä½œåŠ©æ‰‹åº”ç”¨éƒ¨ç½²

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  NODE_VERSION: '18.x'
  
jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ðŸ” ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ è®¾ç½®Node.jsçŽ¯å¢ƒ 
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          server/package-lock.json
          client/package-lock.json
          
    - name: ðŸ“¦ å®‰è£…åŽç«¯ä¾èµ–
      run: |
        cd server
        npm ci
        
    - name: ðŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–  
      run: |
        cd client
        npm ci
        
    - name: ðŸ” ESLintä»£ç æ£€æŸ¥
      run: |
        cd client
        npm run lint || true
        
    - name: ðŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•
      run: |
        cd server
        npm test || true

  # æž„å»ºåº”ç”¨
  build:
    name: ðŸ”¨ æž„å»ºåº”ç”¨
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ è®¾ç½®Node.jsçŽ¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          server/package-lock.json
          client/package-lock.json
          
    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: |
        cd server && npm ci
        cd ../client && npm ci
        
    - name: ðŸ—ï¸ æž„å»ºå‰ç«¯åº”ç”¨
      run: |
        cd client
        CI=false npm run build
        
    - name: ðŸ“‹ ç”Ÿæˆæž„å»ºæŠ¥å‘Š
      run: |
        echo "æž„å»ºæ—¶é—´: $(date)" > build-report.txt
        echo "Nodeç‰ˆæœ¬: $(node --version)" >> build-report.txt
        echo "NPMç‰ˆæœ¬: $(npm --version)" >> build-report.txt
        
    - name: ðŸ’¾ ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          client/build/
          server/
          build-report.txt

  # å®‰å…¨æ‰«æ
  security-scan:
    name: ðŸ”’ å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ è®¾ç½®Node.jsçŽ¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: ðŸ” NPMå®‰å…¨å®¡è®¡ - åŽç«¯
      run: |
        cd server
        npm audit --audit-level=moderate || true
        
    - name: ðŸ” NPMå®‰å…¨å®¡è®¡ - å‰ç«¯
      run: |
        cd client  
        npm audit --audit-level=moderate || true

  # Dockeræž„å»º
  docker-build:
    name: ðŸ³ Dockeræž„å»º
    runs-on: ubuntu-latest
    needs: [build, security-scan]
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸ’¾ ä¸‹è½½æž„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        
    - name: ðŸ³ è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ðŸ”‘ ç™»å½•åˆ°GitHubå®¹å™¨æ³¨å†Œè¡¨
      if: github.ref == 'refs/heads/main'
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ—ï¸ æž„å»ºDockeré•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.prod
        push: ${{ github.ref == 'refs/heads/main' }}
        tags: |
          ghcr.io/${{ github.repository }}:latest
          ghcr.io/${{ github.repository }}:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ
  deploy:
    name: ðŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸ’¾ ä¸‹è½½æž„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        
    - name: ðŸ“‹ éƒ¨ç½²çŠ¶æ€æ£€æŸ¥
      run: |
        echo "å¼€å§‹éƒ¨ç½²æ™ºèƒ½å·¥ä½œåŠ©æ‰‹åº”ç”¨..."
        echo "éƒ¨ç½²çŽ¯å¢ƒ: Production"
        echo "Git SHA: ${{ github.sha }}"
        echo "éƒ¨ç½²æ—¶é—´: $(date)"
        
    # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å®žé™…çš„éƒ¨ç½²æ­¥éª¤
    # ä¾‹å¦‚: éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨ã€Kubernetesé›†ç¾¤ç­‰
    
    - name: ðŸŽ¯ æ¨¡æ‹Ÿç”Ÿäº§éƒ¨ç½²
      run: |
        echo "ðŸš€ æ­£åœ¨éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ..."
        echo "âœ… åº”ç”¨æœåŠ¡å™¨éƒ¨ç½²å®Œæˆ"
        echo "âœ… æ•°æ®åº“è¿žæŽ¥éªŒè¯é€šè¿‡"  
        echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
        echo "ðŸŽ‰ éƒ¨ç½²æˆåŠŸå®Œæˆ!"

  # éƒ¨ç½²çŠ¶æ€é€šçŸ¥
  notify:
    name: ðŸ“¢ éƒ¨ç½²çŠ¶æ€é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
    - name: ðŸ“Š è®¾ç½®éƒ¨ç½²çŠ¶æ€
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "DEPLOYMENT_STATUS=success" >> $GITHUB_ENV
          echo "DEPLOYMENT_COLOR=good" >> $GITHUB_ENV
          echo "DEPLOYMENT_MESSAGE=ðŸŽ‰ æ™ºèƒ½å·¥ä½œåŠ©æ‰‹åº”ç”¨éƒ¨ç½²æˆåŠŸ!" >> $GITHUB_ENV
        else
          echo "DEPLOYMENT_STATUS=failure" >> $GITHUB_ENV  
          echo "DEPLOYMENT_COLOR=danger" >> $GITHUB_ENV
          echo "DEPLOYMENT_MESSAGE=âŒ æ™ºèƒ½å·¥ä½œåŠ©æ‰‹åº”ç”¨éƒ¨ç½²å¤±è´¥" >> $GITHUB_ENV
        fi
        
    - name: ðŸ“ åˆ›å»ºéƒ¨ç½²æ‘˜è¦
      run: |
        echo "## ðŸš€ æ™ºèƒ½å·¥ä½œåŠ©æ‰‹åº”ç”¨éƒ¨ç½²æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**éƒ¨ç½²çŠ¶æ€**: ${{ env.DEPLOYMENT_MESSAGE }}" >> $GITHUB_STEP_SUMMARY
        echo "**åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**éƒ¨ç½²æ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ˆ éƒ¨ç½²ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ” ä»£ç è´¨é‡æ£€æŸ¥: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”¨ åº”ç”¨æž„å»º: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”’ å®‰å…¨æ‰«æ: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ³ Dockeræž„å»º: ${{ needs.docker-build.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸš€ ç”Ÿäº§éƒ¨ç½²: ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY