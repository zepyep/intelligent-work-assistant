# Nginx生产环境配置\n# 智能工作助手应用\n\nuser nginx;\nworker_processes auto;\nerror_log /var/log/nginx/error.log warn;\npid /var/run/nginx.pid;\n\n# 优化连接处理\nworker_rlimit_nofile 65535;\n\nevents {\n    worker_connections 1024;\n    use epoll;\n    multi_accept on;\n    accept_mutex off;\n}\n\nhttp {\n    include /etc/nginx/mime.types;\n    default_type application/octet-stream;\n    \n    # 日志格式\n    log_format main '$remote_addr - $remote_user [$time_local] \"$request\" '\n                    '$status $body_bytes_sent \"$http_referer\" '\n                    '\"$http_user_agent\" \"$http_x_forwarded_for\" '\n                    'rt=$request_time uct=\"$upstream_connect_time\" '\n                    'uht=\"$upstream_header_time\" urt=\"$upstream_response_time\"';\n    \n    log_format json escape=json '{'\n        '\"time_local\":\"$time_local\",' \n        '\"remote_addr\":\"$remote_addr\",' \n        '\"remote_user\":\"$remote_user\",' \n        '\"request\":\"$request\",' \n        '\"status\": \"$status\",' \n        '\"body_bytes_sent\":\"$body_bytes_sent\",' \n        '\"request_time\":\"$request_time\",' \n        '\"http_referrer\":\"$http_referer\",' \n        '\"http_user_agent\":\"$http_user_agent\",' \n        '\"http_x_forwarded_for\":\"$http_x_forwarded_for\"' \n    '}';\n    \n    access_log /var/log/nginx/access.log main;\n    \n    # 基础设置\n    sendfile on;\n    tcp_nopush on;\n    tcp_nodelay on;\n    keepalive_timeout 65;\n    keepalive_requests 1000;\n    types_hash_max_size 2048;\n    \n    # 客户端设置\n    client_body_timeout 60;\n    client_header_timeout 60;\n    client_max_body_size 16M;\n    client_body_buffer_size 16K;\n    client_header_buffer_size 1k;\n    large_client_header_buffers 4 8k;\n    \n    # Gzip压缩\n    gzip on;\n    gzip_vary on;\n    gzip_proxied any;\n    gzip_comp_level 6;\n    gzip_min_length 1000;\n    gzip_types\n        application/atom+xml\n        application/javascript\n        application/json\n        application/ld+json\n        application/manifest+json\n        application/rss+xml\n        application/vnd.geo+json\n        application/vnd.ms-fontobject\n        application/wasm\n        application/x-font-ttf\n        application/x-web-app-manifest+json\n        application/xhtml+xml\n        application/xml\n        font/opentype\n        image/bmp\n        image/svg+xml\n        image/x-icon\n        text/cache-manifest\n        text/css\n        text/plain\n        text/vcard\n        text/vnd.rim.location.xloc\n        text/vtt\n        text/x-component\n        text/x-cross-domain-policy;\n    \n    # 安全头\n    add_header X-Frame-Options \"SAMEORIGIN\" always;\n    add_header X-XSS-Protection \"1; mode=block\" always;\n    add_header X-Content-Type-Options \"nosniff\" always;\n    add_header Referrer-Policy \"strict-origin-when-cross-origin\" always;\n    add_header X-Download-Options \"noopen\" always;\n    add_header X-Permitted-Cross-Domain-Policies \"none\" always;\n    \n    # 隐藏服务器信息\n    server_tokens off;\n    more_clear_headers Server;\n    \n    # 限流配置\n    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;\n    limit_req_zone $binary_remote_addr zone=wechat:10m rate=5r/s;\n    limit_req_zone $binary_remote_addr zone=general:10m rate=20r/s;\n    \n    # 连接限制\n    limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;\n    limit_conn conn_limit_per_ip 20;\n    \n    # 上游服务器配置\n    upstream backend {\n        least_conn;\n        server backend:5000 max_fails=3 fail_timeout=30s weight=1;\n        keepalive 32;\n    }\n    \n    upstream frontend {\n        server frontend:80 max_fails=3 fail_timeout=30s weight=1;\n        keepalive 16;\n    }\n    \n    # 缓存配置\n    proxy_cache_path /var/cache/nginx/api levels=1:2 keys_zone=api_cache:10m \n                     max_size=100m inactive=60m use_temp_path=off;\n    \n    # HTTP重定向到HTTPS\n    server {\n        listen 80;\n        server_name _;\n        \n        # 健康检查允许HTTP访问\n        location /health {\n            access_log off;\n            return 200 \"healthy\\n\";\n            add_header Content-Type text/plain;\n        }\n        \n        # Let's Encrypt验证\n        location /.well-known/acme-challenge/ {\n            root /var/www/certbot;\n        }\n        \n        # 其他请求重定向到HTTPS\n        location / {\n            return 301 https://$host$request_uri;\n        }\n    }\n    \n    # HTTPS主服务器\n    server {\n        listen 443 ssl http2;\n        server_name yourdomain.com www.yourdomain.com;\n        \n        # SSL配置\n        ssl_certificate /etc/nginx/ssl/fullchain.pem;\n        ssl_certificate_key /etc/nginx/ssl/privkey.pem;\n        \n        # SSL安全配置\n        ssl_protocols TLSv1.2 TLSv1.3;\n        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!3DES:!MD5:!PSK;\n        ssl_prefer_server_ciphers off;\n        ssl_session_cache shared:SSL:10m;\n        ssl_session_timeout 10m;\n        ssl_session_tickets off;\n        \n        # HSTS\n        add_header Strict-Transport-Security \"max-age=63072000; includeSubDomains; preload\" always;\n        \n        # CSP头\n        add_header Content-Security-Policy \"default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://api.weixin.qq.com wss:; frame-ancestors 'self';\" always;\n        \n        # 根目录重定向到前端\n        location / {\n            limit_req zone=general burst=20 nodelay;\n            \n            proxy_pass http://frontend;\n            proxy_http_version 1.1;\n            proxy_set_header Upgrade $http_upgrade;\n            proxy_set_header Connection 'upgrade';\n            proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n            proxy_set_header X-Forwarded-Proto $scheme;\n            proxy_set_header X-Forwarded-Host $host;\n            proxy_set_header X-Forwarded-Port $server_port;\n            \n            proxy_cache_bypass $http_upgrade;\n            proxy_buffering on;\n            proxy_buffer_size 4k;\n            proxy_buffers 8 4k;\n            proxy_busy_buffers_size 8k;\n            \n            # 超时设置\n            proxy_connect_timeout 5s;\n            proxy_send_timeout 60s;\n            proxy_read_timeout 60s;\n        }\n        \n        # API代理到后端\n        location /api/ {\n            limit_req zone=api burst=10 nodelay;\n            \n            proxy_pass http://backend;\n            proxy_http_version 1.1;\n            proxy_set_header Upgrade $http_upgrade;\n            proxy_set_header Connection 'upgrade';\n            proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n            proxy_set_header X-Forwarded-Proto $scheme;\n            proxy_set_header X-Forwarded-Host $host;\n            proxy_set_header X-Forwarded-Port $server_port;\n            \n            proxy_cache_bypass $http_upgrade;\n            proxy_buffering on;\n            proxy_buffer_size 8k;\n            proxy_buffers 16 8k;\n            proxy_busy_buffers_size 16k;\n            \n            # 超时设置\n            proxy_connect_timeout 5s;\n            proxy_send_timeout 60s;\n            proxy_read_timeout 60s;\n            \n            # 部分API缓存\n            location ~* ^/api/(health|status) {\n                proxy_pass http://backend;\n                proxy_cache api_cache;\n                proxy_cache_valid 200 302 30s;\n                proxy_cache_valid 404 1m;\n                proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504;\n                add_header X-Cache-Status $upstream_cache_status;\n            }\n        }\n        \n        # 微信Webhook特殊处理\n        location /api/wechat/webhook {\n            limit_req zone=wechat burst=5 nodelay;\n            \n            proxy_pass http://backend;\n            proxy_http_version 1.1;\n            proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n            proxy_set_header X-Forwarded-Proto $scheme;\n            \n            # 微信特殊超时设置\n            proxy_connect_timeout 3s;\n            proxy_send_timeout 5s;\n            proxy_read_timeout 5s;\n            \n            # 禁用缓存\n            proxy_buffering off;\n            proxy_cache off;\n        }\n        \n        # 文件上传处理\n        location /api/documents/upload {\n            client_max_body_size 50M;\n            client_body_timeout 300;\n            proxy_request_buffering off;\n            \n            proxy_pass http://backend;\n            proxy_http_version 1.1;\n            proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n            proxy_set_header X-Forwarded-Proto $scheme;\n            \n            proxy_connect_timeout 5s;\n            proxy_send_timeout 300s;\n            proxy_read_timeout 300s;\n        }\n        \n        # 静态文件服务（上传的文件）\n        location /uploads/ {\n            alias /opt/iwa/data/uploads/;\n            \n            # 缓存设置\n            expires 30d;\n            add_header Cache-Control \"public, no-transform\";\n            \n            # 安全设置\n            add_header X-Content-Type-Options nosniff;\n            \n            # 防止执行上传的脚本\n            location ~ \\.(php|jsp|asp|sh|py|pl|rb)$ {\n                deny all;\n                return 403;\n            }\n        }\n        \n        # 监控端点代理\n        location /grafana/ {\n            proxy_pass http://grafana:3000/;\n            proxy_http_version 1.1;\n            proxy_set_header Upgrade $http_upgrade;\n            proxy_set_header Connection 'upgrade';\n            proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n            proxy_set_header X-Forwarded-Proto $scheme;\n            proxy_cache_bypass $http_upgrade;\n        }\n        \n        # 健康检查（内部使用）\n        location /nginx-health {\n            access_log off;\n            return 200 \"healthy\\n\";\n            add_header Content-Type text/plain;\n            allow 127.0.0.1;\n            allow 172.0.0.0/8;\n            deny all;\n        }\n        \n        # 阻止访问敏感文件\n        location ~ /\\.(ht|git|svn) {\n            deny all;\n            return 404;\n        }\n        \n        location ~ \\.(md|json|lock|yml|yaml|toml)$ {\n            deny all;\n            return 404;\n        }\n        \n        # 错误页面\n        error_page 400 401 403 404 /40x.html;\n        error_page 500 502 503 504 /50x.html;\n        \n        location = /40x.html {\n            root /usr/share/nginx/html;\n            internal;\n        }\n        \n        location = /50x.html {\n            root /usr/share/nginx/html;\n            internal;\n        }\n        \n        # 访问日志\n        access_log /var/log/nginx/access.log main;\n        error_log /var/log/nginx/error.log warn;\n    }\n}